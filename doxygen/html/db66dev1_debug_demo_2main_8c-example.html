<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Netcruzer Library API: db66dev1_debug_demo/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Netcruzer Library API
   &#160;<span id="projectnumber">V2.03</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('db66dev1_debug_demo_2main_8c-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">db66dev1_debug_demo/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<h2>===== Description =====</h2>
<p>This demo shows how to:</p>
<ul>
<li>Read the value of a potentiometer connected to an analog input</li>
<li>Read buttons and control LEDs on the DB66DEV1 development board (using DB66DEV1 driver located in <a class="el" href="nz__db66dev1_8h.html" title="Contains hardware specific defines for DB66DEV1 Revision 1 board. ">nz_db66dev1.h</a>)</li>
<li>Output a frequency with varying duty cycles to a PWM channel. The PWM output is connected to a buzzer, and the duty cycle is used to set the volume.</li>
</ul>
<p>This demo uses a <a href="http://netcruzer.com/db66dev1.html">DB66DEV1</a> development daughter board. It has 4 buttons, 8 LEDs, a potentiometer and a buzzer.</p>
<p>The potentiometer is used to set the frequency of the buzzer to a value between 255 to 2795 Hz.</p>
<p>Buttons 1 and 2 are used to set the volume to a level between 0 to 8. The volume is represented on the LEDs, with volume 0=all LEDs of, and volume 8 all LEDs on.</p>
<p>The PWM duty cycle is set to a value between 0 to 0.33 depending on the current volume setting.</p>
<p>Additionally this demo also implements debugging via the USB port and the <a href="http://www.netcruzer.com/usbterminal/">Netcruzer USB Terminal</a> App. During the program various debug messages are written, which will be displayed on the "Netcruzer USB Terminal" (running on a PC connected to the target board's USB port). This demo also monitors the USB port for Debug messages send to us. <br/>
- If "hi" is received, it replies with "Hello" <br/>
- If "adc" is received, it replies with the analog value of the potentiometer <br/>
Use the "Netcruzer USB Terminal" App to send and receive USB Debug messages. It can be downloaded here: <a href="http://www.netcruzer.com/usbterminal/">http://www.netcruzer.com/usbterminal/</a></p>
<h2>===== Required Hardware =====</h2>
<p>The project requires a <a href="http://netcruzer.com/products-sbc66-main/">SBC66 Netcruzer board</a> with an USB Port (not USB Host), <b>AND</b> a <a href="http://netcruzer.com/db66dev1.html">DB66DEV1</a> development board. The DB66DEV1 is plugged into the daughter board connector of the SBC66 board.</p>
<h2>===== Building Project =====</h2>
<p>This project is located in the "src/demos/db66dev1/db66dev1_debug_demo" folder of the <a href="http://netcruzer.com/nzdownload/" target="_blank">Netcruzer Download</a>. To compile for Netcruzer Board, open this project in MPLAB X, and select the "Project Configuration" for desired board. For example "SBC66ZL_R1" for the <a href="http://netcruzer.com/sbc66zl.html">SBC66ZL</a> Revision 1 board. For details <a href="http://netcruzer.com/nz/doc/building_projects/" target="_blank">click here</a></p>
<h2>===== Programming Board =====</h2>
<p>After compiling (build), the board can be programmed via the <a href="http://netcruzer.com/nz/doc/update_firmware_usb" target="_blank">USB Bootloader</a> or a <a href="http://netcruzer.com/nz/doc/update_firmware_prog" target="_blank">PIC Programmer</a>. USB Programming is simplified when using the SBC board together with a <a href="http://netcruzer.com/nz/doc/update_firmware_usb_pt66" target="_blank">Prototype Board</a>.</p>
<h2>===== File History =====</h2>
<p>2013-07-22, David H. (DH):</p>
<ul>
<li>Initial version</li>
</ul>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#define THIS_IS_MAIN_FILE   //Uniquely identifies this as the file with the main application entry function main()</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Includes /////////////////////////////////////</span></div>
<div class="line"><span class="preprocessor">#include &quot;HardwareProfile.h&quot;</span>    <span class="comment">//Required for all Netcruzer projects</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="nz__db66dev1_8h.html" title="Contains hardware specific defines for DB66DEV1 Revision 1 board. ">nz_db66dev1.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//Add debugging. DEBUG_CONF_MAIN macro sets debugging to desired level (defined in projdefs.h)</span></div>
<div class="line"><span class="preprocessor">#if !defined(DEBUG_CONF_MAIN)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define DEBUG_CONF_MAIN     DEBUG_CONF_DEFAULT   //Default Debug Level, disabled if DEBUG_LEVEL_ALLOFF defined, else DEBUG_LEVEL_ERROR</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MY_DEBUG_LEVEL   DEBUG_CONF_MAIN</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="nz__debug_8h.html" title="This file defines a Debug interface. ">nz_debug.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Variables ////////////////////////////////////</span></div>
<div class="line"><span class="keyword">static</span> WORD potValue = 0, newPotValue = 0;</div>
<div class="line"><span class="keyword">static</span> BYTE volume = 0, newVolume = 0;</div>
<div class="line"><span class="keyword">static</span> BYTE buttons;</div>
<div class="line"><span class="keyword">static</span> WORD tmrFlashLed = 0;        <span class="comment">//Timer for flashing system LED</span></div>
<div class="line"><span class="keyword">static</span> WORD tmrServiceDB66DEV1 = 0; <span class="comment">//Timer for checking button and Potentiometer inputs</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Default initialization. All ports inputs. All analog features disabled. Tick 1ms</span></div>
<div class="line">    <a name="a0"></a><a class="code" href="nz__netcruzer_8h.html#adfed4b7fa101ade26bd57d654f4c7bcd">nzSysInitDefault</a>();</div>
<div class="line"></div>
<div class="line">    <a name="a1"></a><a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nThis is a test debug message from db66dev1 demo&quot;</span>);</div>
<div class="line"></div>
<div class="line">    DIR_SYSLED = OUTPUT_PIN;    <span class="comment">//Set System LED port as outputs</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Initialize DB66DEV1, all LEDs are output and turned off, Buttons inputs</span></div>
<div class="line">    db66dev1_Init();</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Configure port 3 (old port name X3) as ADC channel, is connected to Potentiometer on DB66DEV1</span></div>
<div class="line">    adcOpen(ADC_OPEN_A3);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Congigure port 30 (old port name Y4) (Buzzer on DB66DEV1) as PWM channel 1. </span></div>
<div class="line">    pwm1OpenDefault(PPS_OUT_34, 0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Main loop</span></div>
<div class="line">    <span class="keywordflow">while</span>(1)</div>
<div class="line">    {</div>
<div class="line">        <a name="a2"></a><a class="code" href="nz__netcruzer_8h.html#ad9122988f6a0fb44a89afca419b66e65">nzSysTaskDefault</a>();     <span class="comment">//Main netcruzer task, call in main loop.</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//Service DB66DEV1 every 10ms</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a3"></a><a class="code" href="nz__tick_8h.html#a6ba5b7c684a01befa0d9522a7efa880a">tick16TestTmr</a>(tmrServiceDB66DEV1)) {</div>
<div class="line">            <a name="a4"></a><a class="code" href="nz__tick_8h.html#abd9d8cafb5bb9c655365cebd7bc2bd56">tick16UpdateTmrMS</a>(tmrServiceDB66DEV1, 10);   <span class="comment">//Update timer to expire in 10ms again</span></div>
<div class="line"></div>
<div class="line">            db66dev1_Service();     <span class="comment">//DB66DEV1 service routine. Must be called each 10ms (default, can be changed)</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">//Get latched button value. This function will clear the latched value of all buttons!</span></div>
<div class="line">            buttons = db66dev1_ReadLatchedButtons();</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Was button 2 pressed, increase volume</span></div>
<div class="line">            <span class="keywordflow">if</span>(buttons &amp; 0x02) {</div>
<div class="line">                <span class="comment">//Increase volume, maximum level is 8</span></div>
<div class="line">                <span class="keywordflow">if</span> (newVolume &lt; 8)</div>
<div class="line">                    newVolume++;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">//Was button 1 pressed, decrease volume</span></div>
<div class="line">            <span class="keywordflow">if</span>(buttons &amp; 0x01) {</div>
<div class="line">                <span class="comment">//Decrease volume, minimum level is 0</span></div>
<div class="line">                <span class="keywordflow">if</span> (newVolume != 0)</div>
<div class="line">                    newVolume--;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Get the potentiometer analog input, will be a value from 0 to 255</span></div>
<div class="line">            newPotValue = adcReadChan8BitForIndex(0);    <span class="comment">//Use index function</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">//Only enter if volume of potentiometer value has changed</span></div>
<div class="line">            <span class="keywordflow">if</span> ( (potValue!=newPotValue) || (newVolume!=volume) ) {</div>
<div class="line">                WORD pwmPeriod;</div>
<div class="line">                <span class="keywordtype">float</span> dcRatio;      <span class="comment">//Duty Cycle ratio</span></div>
<div class="line">                potValue = newPotValue;</div>
<div class="line">                volume = newVolume;</div>
<div class="line"></div>
<div class="line">                <span class="comment">//Update LEDs with new volume level.</span></div>
<div class="line">                <span class="comment">//For volume=0, all LEDs are off, for volume=8 all LEDS are on</span></div>
<div class="line">                db66dev1_WriteLeds(0xff &gt;&gt; (8-volume));</div>
<div class="line"></div>
<div class="line">                <span class="comment">//Calculate period with forumula: 0xffff - (potValue * 250) &lt;br&gt;</span></div>
<div class="line">                <span class="comment">//This gives a range of 1785 to 65535, which gives a frequency range</span></div>
<div class="line">                <span class="comment">//of 244 to 8963Hz. For pwmSetPeriod(), the frequency is calculated:</span></div>
<div class="line">                <span class="comment">//PWM Frequency = 16000000 / (period+1)</span></div>
<div class="line">                pwmPeriod = 0xffff - (potValue * 250);</div>
<div class="line">                pwmSetPeriod(1, pwmPeriod);                     <span class="comment">//Set PWM1 period with calculated value</span></div>
<div class="line">                dcRatio = (((float)(volume*volume)) / 192.0);   <span class="comment">//Duty cycle range from 0 to 0.33 (volume*volume gives exponential curve)</span></div>
<div class="line">                pwmSetDutyCycle(1,((<span class="keywordtype">float</span>)pwmPeriod)*dcRatio);  <span class="comment">//Set duty cycle to 25% (one quarter)</span></div>
<div class="line">                <a name="a5"></a><a class="code" href="stdio_8h.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;\nSetting f=%.0fHz and dc=%.2f&quot;</span>, (<span class="keywordtype">double</span>)pwmGetFrequency(1), (<span class="keywordtype">double</span>)dcRatio);  <span class="comment">//Print frequency and duty cycle to Debug Terminal</span></div>
<div class="line"></div>
<div class="line">                <span class="comment">//ALTERNATIVE METHOD, COMMENTED BY DEFAULT!</span></div>
<div class="line">                <span class="comment">//Set frequency and duty cycle.</span></div>
<div class="line">                <span class="comment">//Frequency can have a minimum value of 245. Range is 245 to 2795 Hz</span></div>
<div class="line">                <span class="comment">//Duty cycle has a range from 0 to 0.33. Use exponential curve (volume*volume)</span></div>
<div class="line">                <span class="comment">//pwmSetFreqAndDutyCycle(1, (newPotValue*10)+245, dcRatio );</span></div>
<div class="line">                <span class="comment">//printf(&quot;\nSetting f=%uHz and dc=%.2f&quot;, (newPotValue*10)+245, dcRatio);  //Print frequency and duty cycle to Debug Terminal</span></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Flash system LED every 500ms</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="nz__tick_8h.html#a6ba5b7c684a01befa0d9522a7efa880a">tick16TestTmr</a>(tmrFlashLed)) {</div>
<div class="line">            <a class="code" href="nz__tick_8h.html#abd9d8cafb5bb9c655365cebd7bc2bd56">tick16UpdateTmrMS</a>(tmrFlashLed, 100); <span class="comment">//Update timer to expire in 10ms again</span></div>
<div class="line">            LAT_SYSLED = !LAT_SYSLED;       <span class="comment">//Toggle System LED</span></div>
<div class="line">        }</div>
<div class="line">    }<span class="comment">//end while</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(HAS_NZ_DEBUGGING)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">void</span> debugService(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">//Check if a debug message was received</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a6"></a><a class="code" href="nz__circular_buffer_8h.html#af00a8ce0f071a8a966bc66294fdd9081">cbufHasWholePacket</a>(CIRBUF_RX_DEBUG)) {</div>
<div class="line">        <span class="comment">//&#39;hi&#39; - Reply with &quot;Hello&quot; on a new line</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a7"></a><a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;hi&quot;</span>) == 0) {</div>
<div class="line">            debugPutString(<span class="stringliteral">&quot;\nHello&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//&quot;adc&#39; - Print Potentiometer ADC value</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;adc&quot;</span>) == 0) {</div>
<div class="line">            debugPutString(<span class="stringliteral">&quot;\nADC = &quot;</span>);</div>
<div class="line">            debugPutWord(adcReadChan8BitForIndex(0));</div>
<div class="line">            <span class="comment">//printf(&quot;\nADC = %d&quot;, adcReadChan8BitForIndex(0));  //Alternative method</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Remove received packet. If it was not processed above, it is lost!</span></div>
<div class="line">        <a name="a8"></a><a class="code" href="nz__circular_buffer_8h.html#a41ff25acfdec531e69b8437abb11b720">cbufRemovePacket</a>(CIRBUF_RX_DEBUG);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Dec 9 2014 15:08:18 for Netcruzer Library API by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
