<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Netcruzer: db66dev1_demo1_debug/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Netcruzer
   &#160;<span id="projectnumber">V2.02</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('db66dev1_demo1_debug_2main_8c-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">db66dev1_demo1_debug/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<h2>===== Description =====</h2>
<p>This demo monitors the USB port for any Debug messages. <br/>
- If "hi" is received, it replies with "Hello" <br/>
- If "hello" is received, it replies with "G'Day Mate!" <br/>
Use the "Netcruzer USB Terminal" app to send and receive USB Debug messages. It can be downloaded here: <a href="http://www.netcruzer.com/usbterminal/">http://www.netcruzer.com/usbterminal/</a></p>
<p>This demo does not implement any USB code in the main.c file, and instructs the system to do it all. This is done by including the "NZSYS_MANAGE_USB_HID" define in the projdefs.h file.</p>
<p><b>Details:</b><br/>
 The "Netcruzer Library" contains two circular buffer implementations. Any one can be used for this project. The standard one (nz_circularBufferStd.c) is used for this demo, requiring the following to be done(is already done!):</p>
<ul>
<li>Copy <a class="el" href="nz__circular_buffer_8h.html#nz_circularBuffer_conf">Circular Buffer Configuration</a> section from <a class="el" href="nz__circular_buffer_8h.html" title="This file defines a Circular Buffer interface. ">nz_circularBuffer.h</a> to projdefs.h</li>
<li>In this copied section, ensure "#define    CIRBUF_USE_CIRCULAR_BUFFER_STD" is uncommented. This configures what "Circular Buffer" implementation is used.</li>
<li>Include "nz_circularBufferStd.c" in project</li>
</ul>
<h2>===== Required Hardware =====</h2>
<p>The project requires a <a href="http://netcruzer.com/sbc66-boards/">SBC66 Netcruzer board</a> with an USB Port (not USB Host).</p>
<h2>===== Building Project =====</h2>
<p>This project is located in the "src/demos/usb/db66dev1_demo1_debug" folder of the <a href="http://netcruzer.com/nzdownload/" target="_blank">Netcruzer Download</a>. To compile for Netcruzer Board, open this project in MPLAB X, and select the "Project Configuration" for desired board. For example "SBC66ZL_R1" for the <a href="http://netcruzer.com/sbc66zl.html">SBC66ZL</a> Revision 1 board. For details <a href="http://netcruzer.com/nz/doc/building_projects/" target="_blank">click here</a> A common error is "The system cannot find the path specified". This generally means you don't have the required XC16 compiler version installed. Go to "Project Properties", and select your installed XC16 compiler in the "Project Configuration" section.</p>
<h2>===== Programming Board =====</h2>
<p>After compiling (build), the board can be programmed via the <a href="http://netcruzer.com/nz/doc/update_firmware_usb" target="_blank">USB Bootloader</a> or a <a href="http://netcruzer.com/nz/doc/update_firmware_prog" target="_blank">PIC Programmer</a>. USB Programming is simplified when using the SBC board together with a <a href="http://netcruzer.com/nz/doc/update_firmware_usb_pt66" target="_blank">Prototype Board</a>.</p>
<h2>===== File History =====</h2>
<p>2013-07-22, David H. (DH):</p>
<ul>
<li>Initial version</li>
</ul>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#define THIS_IS_MAIN_FILE   //Uniquely identifies this as the file with the main application entry function main()</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;HardwareProfile.h&quot;</span>    <span class="comment">//Required for all Netcruzer projects</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="nz__helpers_8h.html" title="Netcruzer Helper Functions. ">nz_helpers.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//Add debugging. DEBUG_CONF_MAIN macro sets debugging to desired level (defined in projdefs.h)</span></div>
<div class="line"><span class="preprocessor">#if !defined(DEBUG_CONF_MAIN)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define DEBUG_CONF_MAIN     0   //Debugging not enabled for this file!</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MY_DEBUG_LEVEL   DEBUG_CONF_MAIN</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="nz__debug_8h.html" title="This file defines a Debug interface. ">nz_debug.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line">    WORD potValue;</div>
<div class="line">    WORD pwmValue = 0;              <span class="comment">//Pwm value from 0 to 100 (0 to 100%)</span></div>
<div class="line">    BOOL pwmDecInc = TRUE;          <span class="comment">//Flag used to indicate if PWM duty cycle is currently decreasing (0), or increasing (1)</span></div>
<div class="line">    BYTE ledRotate = 1;</div>
<div class="line"></div>
<div class="line">    WORD tmrFlashLed = 0;           <span class="comment">//Timer for flashing system LED</span></div>
<div class="line">    WORD tmrCheckInputs = 0;        <span class="comment">//Timer for checking button and Potentiometer inputs</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Default initialization. All ports inputs. All analog features disabled. Tick 1ms</span></div>
<div class="line">    <a name="a0"></a><a class="code" href="nz__netcruzer_8h.html#a591be19f2f4adb5f84d6e21413b0fcc4">nzsysInitDefault</a>();</div>
<div class="line"></div>
<div class="line">    <a name="a1"></a><a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nThis is a test debug message from db66dev1_demo1_debug&quot;</span>);</div>
<div class="line"></div>
<div class="line">    DIR_SYSLED = OUTPUT_PIN;    <span class="comment">//Set System LED port as outputs</span></div>
<div class="line"></div>
<div class="line">    <a name="a2"></a><a class="code" href="brd__db66dev1-r1_8h.html#a96409cdf09080ce522b54c570a7d677c">db66dev1_initLeds</a>();        <span class="comment">//Configure all LEDs on the DB66DEV1 board as outputs, and turn them off</span></div>
<div class="line">    <a name="a3"></a><a class="code" href="brd__db66dev1-r1_8h.html#a333b7acf78ad492e1ce5612f8659f0ef">db66dev1_setLeds</a>(0);        <span class="comment">//turn all LEDs off</span></div>
<div class="line">    <a name="a4"></a><a class="code" href="brd__db66dev1-r1_8h.html#acb30727799ef524c3066a93937e56aea">db66dev1_initButtons</a>();     <span class="comment">//Initialize all button port (set as inputs, enable pull-up resistors)</span></div>
<div class="line"></div>
<div class="line">    <a name="a5"></a><a class="code" href="nz__analog_8h.html#ae988ce1360560a132af27c980de8dd27">adcOpen</a>(ADC_OPEN_X3);       <span class="comment">//Configure X3 as ADC channels</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Congigure port Y4 (Buzzer on DB66DEV1) as PWM channel 1. The value of the PWM1_FREQ define determines frequency (1.6kHz, 16kHz or 160kHz),</span></div>
<div class="line">    <span class="comment">//and is 16kHz by default. To change this to 80kHz for example, place following code in projdefs.h file:&lt;br&gt;</span></div>
<div class="line">    <span class="comment">//#define PWM2_FREQ PWM_FREQ_80KHZ</span></div>
<div class="line">    <a name="a6"></a><a class="code" href="nz__pwm_8h.html#a52726762eb175587d34e5ac546c25057">pwm1OpenDefault</a>(PPS_OUT_Y4, 0);</div>
<div class="line">    <a name="a7"></a><a class="code" href="nz__pwm_8h.html#accf1920acf114075642edc02209941fb">pwm1SetPeriod</a>(9000);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">while</span>(1)</div>
<div class="line">    {</div>
<div class="line">        <a name="a8"></a><a class="code" href="nz__netcruzer_8h.html#ad2f434650d0ff9e33add69c425c41771">nzsysTaskDefault</a>();     <span class="comment">//Main netcruzer task, call in main loop.</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//If X3 analog input is above 2.0V (2000mV), ....</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a9"></a><a class="code" href="nz__analog_8h.html#a3e6b23e06b7350d7d9c7adde0bac0b5d">adcGetChanMv</a>(ADC_CH_X3) &gt; 2000) {</div>
<div class="line">            <span class="comment">//LAT_LED1 = 0;</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> {</div>
<div class="line">            <span class="comment">//LAT_LED1 = 1;</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//int i = SHRT_MIN;</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//Check user inputs every 20ms</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a10"></a><a class="code" href="nz__tick_8h.html#aa0f42d9f39952fe9447d27c21a6d40ab">tickHasExpired</a>(tmrCheckInputs)) {</div>
<div class="line">            <a name="a11"></a><a class="code" href="nz__tick_8h.html#a2138d47ebbf6ffc2b938caf12c5d7f29">tickUpdateMS</a>(tmrCheckInputs, 20);   <span class="comment">//Update timer to expire in 20ms again</span></div>
<div class="line">            WORD newPotValue;</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Check if potentiometer has changed</span></div>
<div class="line">            newPotValue = <a name="a12"></a><a class="code" href="nz__analog_8h.html#a80e7503299008987818f14a3bc9f04ad">adcGetChan8BitForIndex</a>(0);</div>
<div class="line">            <span class="keywordflow">if</span> (potValue != newPotValue) {</div>
<div class="line">                potValue = newPotValue;</div>
<div class="line"></div>
<div class="line">                <span class="comment">//Set volume</span></div>
<div class="line">                <span class="comment">//pwm1SetDutyCycle(potValue);</span></div>
<div class="line"></div>
<div class="line">                <span class="comment">//Set frequency</span></div>
<div class="line">                <span class="comment">//newPotValue &lt;&lt;= 7;</span></div>
<div class="line">                <span class="comment">//pwm1SetPeriod(newPotValue);</span></div>
<div class="line">                <span class="comment">//pwm1SetDutyCycle(newPotValue/2);</span></div>
<div class="line"></div>
<div class="line">                pwmSetFreqAndDC(1, newPotValue * 30, 0.01);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Check buttons</span></div>
<div class="line">            <span class="keywordflow">if</span> (!PIN_BUTTON1) LAT_LED1 = 1;</div>
<div class="line">            <span class="keywordflow">if</span> (!PIN_BUTTON2) LAT_LED2 = 1;</div>
<div class="line">            <span class="keywordflow">if</span> (!PIN_BUTTON3) LAT_LED3 = 1;</div>
<div class="line">            <span class="keywordflow">if</span> (!PIN_BUTTON4) LAT_LED4 = 1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Flash system LED every 500ms</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="nz__tick_8h.html#aa0f42d9f39952fe9447d27c21a6d40ab">tickHasExpired</a>(tmrFlashLed)) {</div>
<div class="line">            <a class="code" href="nz__tick_8h.html#a2138d47ebbf6ffc2b938caf12c5d7f29">tickUpdateMS</a>(tmrFlashLed, 50); <span class="comment">//Update timer to expire in 100ms again</span></div>
<div class="line">            LAT_SYSLED = !LAT_SYSLED;       <span class="comment">//Toggle System LED</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">//Rotate LEDs</span></div>
<div class="line">            ledRotate = ledRotate &lt;&lt; 1;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate==0)</div>
<div class="line">                ledRotate = 0x01;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x01) LAT_LED1 = 1; <span class="keywordflow">else</span> LAT_LED1 = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x02) LAT_LED2 = 1; <span class="keywordflow">else</span> LAT_LED2 = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x04) LAT_LED3 = 1; <span class="keywordflow">else</span> LAT_LED3 = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x08) LAT_LED4 = 1; <span class="keywordflow">else</span> LAT_LED4 = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x10) LAT_LED5 = 1; <span class="keywordflow">else</span> LAT_LED5 = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x20) LAT_LED6 = 1; <span class="keywordflow">else</span> LAT_LED6 = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x40) LAT_LED7 = 1; <span class="keywordflow">else</span> LAT_LED7 = 0;</div>
<div class="line">            <span class="keywordflow">if</span> (ledRotate&amp;0x80) LAT_LED8 = 1; <span class="keywordflow">else</span> LAT_LED8 = 0;</div>
<div class="line">        }</div>
<div class="line">    }<span class="comment">//end while</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (DEBUGGING_ENABLED == 1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">void</span> debugService(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">//Check if a debug message was received</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a13"></a><a class="code" href="nz__circular_buffer_8h.html#af00a8ce0f071a8a966bc66294fdd9081">cbufHasWholePacket</a>(CIRBUF_RX_DEBUG)) {</div>
<div class="line">        <span class="comment">//&#39;hi&#39; - Reply with &quot;Hello&quot; on a new line</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a14"></a><a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;hi&quot;</span>) == 0) {</div>
<div class="line">            <a name="a15"></a><a class="code" href="nz__circular_buffer_8h.html#aaf805c529e964381d5c1d5e8e98e893d">cbufPutString</a>(CIRBUF_TX_DEBUG, <span class="stringliteral">&quot;\nHello&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//&quot;adc&#39; - Print Potentiometer ADC value</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;adc&quot;</span>) == 0) {</div>
<div class="line">            <a name="a16"></a><a class="code" href="stdio_8h.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;\nADC = %d&quot;</span>, <a class="code" href="nz__analog_8h.html#a80e7503299008987818f14a3bc9f04ad">adcGetChan8BitForIndex</a>(0));</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Remove received packet. If it was not processed above, it is lost!</span></div>
<div class="line">        <a name="a17"></a><a class="code" href="nz__circular_buffer_8h.html#a41ff25acfdec531e69b8437abb11b720">cbufRemovePacket</a>(CIRBUF_RX_DEBUG);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Sep 3 2013 11:20:16 for Netcruzer by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
