<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Netcruzer Library API: usb/device_MIDI/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Netcruzer Library API
   &#160;<span id="projectnumber">V2.03</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('usb_2device__m_i_d_i_2main_8c-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">usb/device_MIDI/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<h2>===== Description =====</h2>
<p>This demo uses the selected hardware platform as a USB MIDI device. Connect the device to the computer. Open a MIDI recording software package. Each MIDI recording software interface is different so the following instructions may not apply the to software package you are using. Please refer to the userâ€™s manual for the software package you are using for more details of how to configure that tool for a USB MIDI input. In this demo each time you press the button on the board, it will cycle through a series of notes. The port that button is connected to is Netcruzer Port 5 (old port name X5). The button must short port 5 to ground when pressed. To change port, change following line in HardwareProfile.h: "#define sw2 PIN_05"</p>
<h2>===== Required Hardware =====</h2>
<p>This project can be run on any of our <a href="http://netcruzer.com/products-sbc66-main/">SBC66 Netcruzer boards</a>. For prototyping, we recommend combining this board with a <a href="http://netcruzer.com/products-sbc66-prototype/">Prototyping Board</a>, like the PT66ECI for example. This low cost prototyping board makes all the I/O ports of the SBC66 board available via marked labels on the PCB. It also provides a reset and firmware button that simplifies prototyping.</p>
<h2>===== Building Project =====</h2>
<p>This project is located in the "src/demos/usb/device_MIDI" folder of the <a href="http://netcruzer.com/nzdownload/" target="_blank">Netcruzer Download</a>. To compile for Netcruzer Board, open this project in MPLAB X, and select the "Project Configuration" for desired board. For example "SBC66ECL_R2" for the <a href="http://netcruzer.com/sbc66ecl.html">SBC66ECL</a> Revision 2 board. For details <a href="http://netcruzer.com/nz/doc/building_projects/" target="_blank">click here</a></p>
<h2>===== Programming Board =====</h2>
<p>After compiling (build), the board can be programmed via the <a href="http://netcruzer.com/nz/doc/update_firmware_usb" target="_blank">USB Bootloader</a> or a <a href="http://netcruzer.com/nz/doc/update_firmware_prog" target="_blank">PIC Programmer</a>. USB Programming is simplified when using the SBC board together with a <a href="http://netcruzer.com/nz/doc/update_firmware_usb_pt66" target="_blank">Prototype Board</a>.</p>
<h2>===== File History =====</h2>
<p>2012-08-08, David H. (DH):</p>
<ul>
<li>Initial version, ported from Microchip MAL example</li>
</ul>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#define THIS_IS_MAIN_FILE   //Uniquely identifies this as the file with the main application entry function main()</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &quot;HardwareProfile.h&quot;</span>            <span class="comment">//Required for all Netcruzer projects</span></div>
<div class="line"><span class="preprocessor">#include &quot;./USB/usb.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;./USB/usb_function_midi.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define RX_BUFFER_ADDRESS_TAG</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define TX_BUFFER_ADDRESS_TAG</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MIDI_EVENT_ADDRESS_TAG</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ReceivedDataBuffer[64] RX_BUFFER_ADDRESS_TAG;</div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ToSendDataBuffer[64] TX_BUFFER_ADDRESS_TAG;</div>
<div class="line">USB_AUDIO_MIDI_EVENT_PACKET midiData MIDI_EVENT_ADDRESS_TAG;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">USB_HANDLE USBTxHandle = 0;</div>
<div class="line">USB_HANDLE USBRxHandle = 0;</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">USB_VOLATILE BYTE msCounter;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> blinkUSBStatus(<span class="keywordtype">void</span>);</div>
<div class="line">BOOL Switch2IsPressed(<span class="keywordtype">void</span>);</div>
<div class="line">BOOL Switch3IsPressed(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> InitializeSystem(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> ProcessIO(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> UserInit(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> YourHighPriorityISRCode();</div>
<div class="line"><span class="keywordtype">void</span> YourLowPriorityISRCode();</div>
<div class="line"><span class="keywordtype">void</span> usbCBSendResume(<span class="keywordtype">void</span>);</div>
<div class="line">WORD_VAL ReadPOT(<span class="keywordtype">void</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/********************************************************************</span></div>
<div class="line"><span class="comment"> * Function:        void main(void)</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * PreCondition:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Input:           None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Output:          None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Side Effects:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Overview:        Main program entry point.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Note:            None</span></div>
<div class="line"><span class="comment"> *******************************************************************/</span></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    InitializeSystem();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #if defined(USB_INTERRUPT)</span></div>
<div class="line"><span class="preprocessor"></span>        USBDeviceAttach();</div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">while</span>(1)</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">        #if defined(USB_POLLING)</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">// Check bus status and service USB interrupts.</span></div>
<div class="line">        USBDeviceTasks(); <span class="comment">// Interrupt or polling method.  If using polling, must call</span></div>
<div class="line">                          <span class="comment">// this function periodically.  This function will take care</span></div>
<div class="line">                          <span class="comment">// of processing and responding to SETUP transactions </span></div>
<div class="line">                          <span class="comment">// (such as during the enumeration process when you first</span></div>
<div class="line">                          <span class="comment">// plug in).  USB hosts require that USB devices should accept</span></div>
<div class="line">                          <span class="comment">// and process SETUP packets in a timely fashion.  Therefore,</span></div>
<div class="line">                          <span class="comment">// when using polling, this function should be called </span></div>
<div class="line">                          <span class="comment">// regularly (such as once every 1.8ms or faster** [see </span></div>
<div class="line">                          <span class="comment">// inline code comments in usb_device.c for explanation when</span></div>
<div class="line">                          <span class="comment">// &quot;or faster&quot; applies])  In most cases, the USBDeviceTasks() </span></div>
<div class="line">                          <span class="comment">// function does not take very long to execute (ex: &lt;100 </span></div>
<div class="line">                          <span class="comment">// instruction cycles) before it returns.</span></div>
<div class="line"><span class="preprocessor">        #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Application-specific tasks.</span></div>
<div class="line">        <span class="comment">// Application related code may be added here, or in the ProcessIO() function.</span></div>
<div class="line">        ProcessIO();</div>
<div class="line">    }<span class="comment">//end while</span></div>
<div class="line">}<span class="comment">//end main</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/********************************************************************</span></div>
<div class="line"><span class="comment"> * Function:        static void InitializeSystem(void)</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * PreCondition:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Input:           None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Output:          None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Side Effects:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Overview:        InitializeSystem is a centralize initialization</span></div>
<div class="line"><span class="comment"> *                  routine. All required USB initialization routines</span></div>
<div class="line"><span class="comment"> *                  are called from here.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *                  User application initialization routine should</span></div>
<div class="line"><span class="comment"> *                  also be called from here.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Note:            None</span></div>
<div class="line"><span class="comment"> *******************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> InitializeSystem(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a name="a0"></a><a class="code" href="nz__netcruzer_8h.html#adfed4b7fa101ade26bd57d654f4c7bcd">nzSysInitDefault</a>();     <span class="comment">//Default initialization. All ports inputs. All analog features disabled</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//  The USB specifications require that USB peripheral devices must never source</span></div>
<div class="line"><span class="comment">//  current onto the Vbus pin.  Additionally, USB peripherals should not source</span></div>
<div class="line"><span class="comment">//  current on D+ or D- when the host/hub is not actively powering the Vbus line.</span></div>
<div class="line"><span class="comment">//  When designing a self powered (as opposed to bus powered) USB peripheral</span></div>
<div class="line"><span class="comment">//  device, the firmware should make sure not to turn on the USB module and D+</span></div>
<div class="line"><span class="comment">//  or D- pull up resistor unless Vbus is actively powered.  Therefore, the</span></div>
<div class="line"><span class="comment">//  firmware needs some means to detect when Vbus is being powered by the host.</span></div>
<div class="line"><span class="comment">//  A 5V tolerant I/O pin can be connected to Vbus (through a resistor), and</span></div>
<div class="line"><span class="comment">//  can be used to detect when Vbus is high (host actively powering), or low</span></div>
<div class="line"><span class="comment">//  (host is shut down or otherwise not supplying power).  The USB firmware</span></div>
<div class="line"><span class="comment">//  can then periodically poll this I/O pin to know when it is okay to turn on</span></div>
<div class="line"><span class="comment">//  the USB module/D+/D- pull up resistor.  When designing a purely bus powered</span></div>
<div class="line"><span class="comment">//  peripheral device, it is not possible to source current on D+ or D- when the</span></div>
<div class="line"><span class="comment">//  host is not actively providing power on Vbus. Therefore, implementing this</span></div>
<div class="line"><span class="comment">//  bus sense feature is optional.  This firmware can be made to use this bus</span></div>
<div class="line"><span class="comment">//  sense feature by making sure &quot;USE_USB_BUS_SENSE_IO&quot; has been defined in the</span></div>
<div class="line"><span class="comment">//  HardwareProfile.h file.</span></div>
<div class="line"><span class="preprocessor">    #if defined(USE_USB_BUS_SENSE_IO)</span></div>
<div class="line"><span class="preprocessor"></span>    tris_usb_bus_sense = <a name="a1"></a><a class="code" href="nz__board_8h.html#a1a806e0533aa476bb6e62b7d22c93572" title="Macros for input and output pins. ">INPUT_PIN</a>; <span class="comment">// See HardwareProfile.h</span></div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">//  If the host PC sends a GetStatus (device) request, the firmware must respond</span></div>
<div class="line"><span class="comment">//  and let the host know if the USB peripheral device is currently bus powered</span></div>
<div class="line"><span class="comment">//  or self powered.  See chapter 9 in the official USB specifications for details</span></div>
<div class="line"><span class="comment">//  regarding this request.  If the peripheral device is capable of being both</span></div>
<div class="line"><span class="comment">//  self and bus powered, it should not return a hard coded value for this request.</span></div>
<div class="line"><span class="comment">//  Instead, firmware should check if it is currently self or bus powered, and</span></div>
<div class="line"><span class="comment">//  respond accordingly.  If the hardware has been configured like demonstrated</span></div>
<div class="line"><span class="comment">//  on the PICDEM FS USB Demo Board, an I/O pin can be polled to determine the</span></div>
<div class="line"><span class="comment">//  currently selected power source.  On the PICDEM FS USB Demo Board, &quot;RA2&quot;</span></div>
<div class="line"><span class="comment">//  is used for this purpose.  If using this feature, make sure &quot;USE_SELF_POWER_SENSE_IO&quot;</span></div>
<div class="line"><span class="comment">//  has been defined in HardwareProfile - (platform).h, and that an appropriate I/O pin </span></div>
<div class="line"><span class="comment">//  has been mapped to it.</span></div>
<div class="line"><span class="preprocessor">    #if defined(USE_SELF_POWER_SENSE_IO)</span></div>
<div class="line"><span class="preprocessor"></span>    tris_self_power = <a class="code" href="nz__board_8h.html#a1a806e0533aa476bb6e62b7d22c93572" title="Macros for input and output pins. ">INPUT_PIN</a>;    <span class="comment">// See HardwareProfile.h</span></div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    UserInit();</div>
<div class="line"></div>
<div class="line">    USBDeviceInit();    <span class="comment">//usb_device.c.  Initializes USB module SFRs and firmware</span></div>
<div class="line">                        <span class="comment">//variables to known states.</span></div>
<div class="line">}<span class="comment">//end InitializeSystem</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/******************************************************************************</span></div>
<div class="line"><span class="comment"> * Function:        void UserInit(void)</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * PreCondition:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Input:           None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Output:          None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Side Effects:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Overview:        This routine should take care of all of the demo code</span></div>
<div class="line"><span class="comment"> *                  initialization that is required.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Note:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *****************************************************************************/</span></div>
<div class="line"><span class="keywordtype">void</span> UserInit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//Initialize all of the LED pins</span></div>
<div class="line">    mInitAllLEDs();</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Initialize all of the push buttons</span></div>
<div class="line">    mInitAllSwitches();</div>
<div class="line"></div>
<div class="line">    <span class="comment">//initialize the variable holding the handle for the last</span></div>
<div class="line">    <span class="comment">// transmission</span></div>
<div class="line">    USBTxHandle = <a name="a2"></a><a class="code" href="stddef_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line">    USBRxHandle = <a class="code" href="stddef_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line">}<span class="comment">//end UserInit</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/********************************************************************</span></div>
<div class="line"><span class="comment"> * Function:        void ProcessIO(void)</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * PreCondition:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Input:           None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Output:          None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Side Effects:    None</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Overview:        This function is a place holder for other user</span></div>
<div class="line"><span class="comment"> *                  routines. It is a mixture of both USB and</span></div>
<div class="line"><span class="comment"> *                  non-USB tasks.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Note:            None</span></div>
<div class="line"><span class="comment"> *******************************************************************/</span></div>
<div class="line"><span class="keywordtype">void</span> ProcessIO(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> BYTE pitch = 0x3C;</div>
<div class="line">    <span class="keyword">static</span> BOOL sentNoteOff = TRUE;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Blink the LEDs according to the USB device status</span></div>
<div class="line">    blinkUSBStatus();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// User Application USB tasks</span></div>
<div class="line">    <span class="keywordflow">if</span>((USBDeviceState &lt; CONFIGURED_STATE)||(USBSuspendControl==1)) <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(!USBHandleBusy(USBRxHandle))</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//We have received a MIDI packet from the host, process it and then</span></div>
<div class="line">        <span class="comment">//  prepare to receive the next packet</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//INSERT MIDI PROCESSING CODE HERE</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//Get ready for next packet (this will overwrite the old data)</span></div>
<div class="line">        USBRxHandle = USBRxOnePacket(MIDI_EP,(BYTE*)&amp;ReceivedDataBuffer,64);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(sw2==0)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(msCounter == 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(sentNoteOff == TRUE)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span>(!USBHandleBusy(USBTxHandle))</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">//Debounce counter for 100ms</span></div>
<div class="line">                    msCounter = 100;</div>
<div class="line"></div>
<div class="line">                    midiData.Val = 0;   <span class="comment">//must set all unused values to 0 so go ahead</span></div>
<div class="line">                                        <span class="comment">//  and set them all to 0</span></div>
<div class="line"></div>
<div class="line">                    midiData.CableNumber = 0;</div>
<div class="line">                    midiData.CodeIndexNumber = MIDI_CIN_NOTE_ON;</div>
<div class="line">                    midiData.DATA_0 = 0x90;         <span class="comment">//Note on</span></div>
<div class="line">                    midiData.DATA_1 = pitch;         <span class="comment">//pitch</span></div>
<div class="line">                    midiData.DATA_2 = 0x7F;  <span class="comment">//velocity</span></div>
<div class="line"></div>
<div class="line">                    USBTxHandle = USBTxOnePacket(MIDI_EP,(BYTE*)&amp;midiData,4);</div>
<div class="line">                    sentNoteOff = FALSE;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(msCounter == 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(sentNoteOff == FALSE)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span>(!USBHandleBusy(USBTxHandle))</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">//Debounce counter for 100ms</span></div>
<div class="line">                    msCounter = 100;</div>
<div class="line"></div>
<div class="line">                    midiData.Val = 0;   <span class="comment">//must set all unused values to 0 so go ahead and set them all to 0</span></div>
<div class="line"></div>
<div class="line">                    midiData.CableNumber = 0;</div>
<div class="line">                    midiData.CodeIndexNumber = MIDI_CIN_NOTE_ON;</div>
<div class="line">                    midiData.DATA_0 = 0x90;     <span class="comment">//Note off</span></div>
<div class="line">                    midiData.DATA_1 = pitch++;     <span class="comment">//pitch</span></div>
<div class="line">                    midiData.DATA_2 = 0x00;        <span class="comment">//velocity</span></div>
<div class="line"></div>
<div class="line">                    <span class="keywordflow">if</span>(pitch == 0x49)</div>
<div class="line">                    {</div>
<div class="line">                        pitch = 0x3C;</div>
<div class="line">                    }</div>
<div class="line"></div>
<div class="line">                    USBTxHandle = USBTxOnePacket(MIDI_EP,(BYTE*)&amp;midiData,4);</div>
<div class="line">                    sentNoteOff = TRUE;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">}<span class="comment">//end ProcessIO</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> blinkUSBStatus(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> WORD led_count=0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(led_count == 0)led_count = 64000U;</div>
<div class="line">    led_count--;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #define mLED_Both_Off()         {mLED_1_Off();mLED_2_Off();}</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define mLED_Both_On()          {mLED_1_On();mLED_2_On();}</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define mLED_Only_1_On()        {mLED_1_On();mLED_2_Off();}</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define mLED_Only_2_On()        {mLED_1_Off();mLED_2_On();}</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">if</span>(USBSuspendControl == 1)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(led_count==0)</div>
<div class="line">        {</div>
<div class="line">            mLED_1_Toggle();</div>
<div class="line">            <span class="keywordflow">if</span>(mGetLED_1())</div>
<div class="line">            {</div>
<div class="line">                mLED_2_On();</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                mLED_2_Off();</div>
<div class="line">            }</div>
<div class="line">        }<span class="comment">//end if</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(USBDeviceState == DETACHED_STATE)</div>
<div class="line">        {</div>
<div class="line">            mLED_Both_Off();</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(USBDeviceState == ATTACHED_STATE)</div>
<div class="line">        {</div>
<div class="line">            mLED_Both_On();</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(USBDeviceState == POWERED_STATE)</div>
<div class="line">        {</div>
<div class="line">            mLED_Only_1_On();</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(USBDeviceState == DEFAULT_STATE)</div>
<div class="line">        {</div>
<div class="line">            mLED_Only_2_On();</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(USBDeviceState == ADDRESS_STATE)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(led_count == 0)</div>
<div class="line">            {</div>
<div class="line">                mLED_1_Toggle();</div>
<div class="line">                mLED_2_Off();</div>
<div class="line">            }<span class="comment">//end if</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(USBDeviceState == CONFIGURED_STATE)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">if</span>(led_count==0)</div>
<div class="line">            {</div>
<div class="line">                mLED_1_Toggle();</div>
<div class="line">                <span class="keywordflow">if</span>(mGetLED_1())</div>
<div class="line">                {</div>
<div class="line">                    mLED_2_Off();</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    mLED_2_On();</div>
<div class="line">                }</div>
<div class="line">            }<span class="comment">//end if</span></div>
<div class="line">        }<span class="comment">//end if(...)</span></div>
<div class="line">    }<span class="comment">//end if(UCONbits.SUSPND...)</span></div>
<div class="line"></div>
<div class="line">}<span class="comment">//end blinkUSBStatus</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// ******************************************************************************************************</span></div>
<div class="line"><span class="comment">// ************** USB Callback Functions ****************************************************************</span></div>
<div class="line"><span class="comment">// ******************************************************************************************************</span></div>
<div class="line"><span class="comment">// The USB firmware stack will call the callback functions USBCBxxx() in response to certain USB related</span></div>
<div class="line"><span class="comment">// events.  For example, if the host PC is powering down, it will stop sending out Start of Frame (SOF)</span></div>
<div class="line"><span class="comment">// packets to your device.  In response to this, all USB devices are supposed to decrease their power</span></div>
<div class="line"><span class="comment">// consumption from the USB Vbus to &lt;2.5mA* each.  The USB module detects this condition (which according</span></div>
<div class="line"><span class="comment">// to the USB specifications is 3+ms of no bus activity/SOF packets) and then calls the USBCBSuspend()</span></div>
<div class="line"><span class="comment">// function.  You should modify these callback functions to take appropriate actions for each of these</span></div>
<div class="line"><span class="comment">// conditions.  For example, in the USBCBSuspend(), you may wish to add code that will decrease power</span></div>
<div class="line"><span class="comment">// consumption from Vbus to &lt;2.5mA (such as by clock switching, turning off LEDs, putting the</span></div>
<div class="line"><span class="comment">// microcontroller to sleep, etc.).  Then, in the USBCBWakeFromSuspend() function, you may then wish to</span></div>
<div class="line"><span class="comment">// add code that undoes the power saving things done in the USBCBSuspend() function.</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// The usbCBSendResume() function is special, in that the USB stack will not automatically call this</span></div>
<div class="line"><span class="comment">// function.  This function is meant to be called from the application firmware instead.  See the</span></div>
<div class="line"><span class="comment">// additional comments near the function.</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Note *: The &quot;usb_20.pdf&quot; specs indicate 500uA or 2.5mA, depending upon device classification. However,</span></div>
<div class="line"><span class="comment">// the USB-IF has officially issued an ECN (engineering change notice) changing this to 2.5mA for all </span></div>
<div class="line"><span class="comment">// devices.  Make sure to re-download the latest specifications to get all of the newest ECNs.</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBSuspend(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//Example power saving code.  Insert appropriate code here for the desired</span></div>
<div class="line">    <span class="comment">//application behavior.  If the microcontroller will be put to sleep, a</span></div>
<div class="line">    <span class="comment">//process similar to that shown below may be used:</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//ConfigureIOPinsForLowPower();</span></div>
<div class="line">    <span class="comment">//SaveStateOfAllInterruptEnableBits();</span></div>
<div class="line">    <span class="comment">//DisableAllInterruptEnableBits();</span></div>
<div class="line">    <span class="comment">//EnableOnlyTheInterruptsWhichWillBeUsedToWakeTheMicro();   //should enable at least USBActivityIF as a wake source</span></div>
<div class="line">    <span class="comment">//Sleep();</span></div>
<div class="line">    <span class="comment">//RestoreStateOfAllPreviouslySavedInterruptEnableBits();    //Preferrably, this should be done in the USBCBWakeFromSuspend() function instead.</span></div>
<div class="line">    <span class="comment">//RestoreIOPinsToNormal();                                  //Preferrably, this should be done in the USBCBWakeFromSuspend() function instead.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//IMPORTANT NOTE: Do not clear the USBActivityIF (ACTVIF) bit here.  This bit is</span></div>
<div class="line">    <span class="comment">//cleared inside the usb_device.c file.  Clearing USBActivityIF here will cause</span></div>
<div class="line">    <span class="comment">//things to not work as intended.</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">   </div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBWakeFromSuspend(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// If clock switching or other power savings measures were taken when</span></div>
<div class="line">    <span class="comment">// executing the USBCBSuspend() function, now would be a good time to</span></div>
<div class="line">    <span class="comment">// switch back to normal full power run mode conditions.  The host allows</span></div>
<div class="line">    <span class="comment">// 10+ milliseconds of wakeup time, after which the device must be </span></div>
<div class="line">    <span class="comment">// fully back to normal, and capable of receiving and processing USB</span></div>
<div class="line">    <span class="comment">// packets.  In order to do this, the USB module must receive proper</span></div>
<div class="line">    <span class="comment">// clocking (IE: 48MHz clock must be available to SIE for full speed USB</span></div>
<div class="line">    <span class="comment">// operation).  </span></div>
<div class="line">    <span class="comment">// Make sure the selected oscillator settings are consistent with USB </span></div>
<div class="line">    <span class="comment">// operation before returning from this function.</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCB_SOF_Handler(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// No need to clear UIRbits.SOFIF to 0 here.</span></div>
<div class="line">    <span class="comment">// Callback caller is already doing that.</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>(msCounter != 0)</div>
<div class="line">    {</div>
<div class="line">        msCounter--;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBErrorHandler(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">// No need to clear UEIR to 0 here.</span></div>
<div class="line">    <span class="comment">// Callback caller is already doing that.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Typically, user firmware does not need to do anything special</span></div>
<div class="line">    <span class="comment">// if a USB error occurs.  For example, if the host sends an OUT</span></div>
<div class="line">    <span class="comment">// packet to your device, but the packet gets corrupted (ex:</span></div>
<div class="line">    <span class="comment">// because of a bad connection, or the user unplugs the</span></div>
<div class="line">    <span class="comment">// USB cable during the transmission) this will typically set</span></div>
<div class="line">    <span class="comment">// one or more USB error interrupt flags.  Nothing specific</span></div>
<div class="line">    <span class="comment">// needs to be done however, since the SIE will automatically</span></div>
<div class="line">    <span class="comment">// send a &quot;NAK&quot; packet to the host.  In response to this, the</span></div>
<div class="line">    <span class="comment">// host will normally retry to send the packet again, and no</span></div>
<div class="line">    <span class="comment">// data loss occurs.  The system will typically recover</span></div>
<div class="line">    <span class="comment">// automatically, without the need for application firmware</span></div>
<div class="line">    <span class="comment">// intervention.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Nevertheless, this callback function is provided, such as</span></div>
<div class="line">    <span class="comment">// for debugging purposes.</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBCheckOtherReq(<span class="keywordtype">void</span>) {</div>
<div class="line"><span class="preprocessor">    #if defined(USB_IS_CDC)</span></div>
<div class="line"><span class="preprocessor"></span>        USBCheckCDCRequest();</div>
<div class="line"><span class="preprocessor">    #elif defined(USB_IS_HID)</span></div>
<div class="line"><span class="preprocessor"></span>        USBCheckHIDRequest();</div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span>}<span class="comment">//end</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBStdSetDscHandler(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">// Must claim session ownership if supporting this request</span></div>
<div class="line">}<span class="comment">//end</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBInitEP(<span class="keywordtype">void</span>) {</div>
<div class="line"><span class="preprocessor">    #if defined(USB_IS_CDC)</span></div>
<div class="line"><span class="preprocessor"></span>        CDCInitEP();</div>
<div class="line"><span class="preprocessor">    #elif defined(USB_IS_HID)</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">//enable the HID endpoint</span></div>
<div class="line">        USBEnableEndpoint(HID_EP,USB_IN_ENABLED|USB_OUT_ENABLED|USB_HANDSHAKE_ENABLED|USB_DISALLOW_SETUP);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Arm the OUT endpoint for the first packet</span></div>
<div class="line">        <span class="comment">//USBOutHandle = HIDRxPacket(HID_EP,(BYTE*)&amp;PacketFromPCBuffer,64);</span></div>
<div class="line">        USBOutHandle = HIDRxPacket(HID_EP,(BYTE*)&amp;PacketFromPC,64);</div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> usbCBSendResume(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keyword">static</span> WORD delay_count;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//First verify that the host has armed us to perform remote wakeup.</span></div>
<div class="line">    <span class="comment">//It does this by sending a SET_FEATURE request to enable remote wakeup,</span></div>
<div class="line">    <span class="comment">//usually just before the host goes to standby mode (note: it will only</span></div>
<div class="line">    <span class="comment">//send this SET_FEATURE request if the configuration descriptor declares</span></div>
<div class="line">    <span class="comment">//the device as remote wakeup capable, AND, if the feature is enabled</span></div>
<div class="line">    <span class="comment">//on the host (ex: on Windows based hosts, in the device manager</span></div>
<div class="line">    <span class="comment">//properties page for the USB device, power management tab, the</span></div>
<div class="line">    <span class="comment">//&quot;Allow this device to bring the computer out of standby.&quot; checkbox</span></div>
<div class="line">    <span class="comment">//should be checked).</span></div>
<div class="line">    <span class="keywordflow">if</span> (USBGetRemoteWakeupStatus() == TRUE) {</div>
<div class="line">        <span class="comment">//Verify that the USB bus is in fact suspended, before we send</span></div>
<div class="line">        <span class="comment">//remote wakeup signalling.</span></div>
<div class="line">        <span class="keywordflow">if</span> (USBIsBusSuspended() == TRUE) {</div>
<div class="line">            USBMaskInterrupts();</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Clock switch to settings consistent with normal USB operation.</span></div>
<div class="line">            USBCBWakeFromSuspend();</div>
<div class="line">            USBSuspendControl = 0;</div>
<div class="line">            USBBusIsSuspended = FALSE; <span class="comment">//So we don&#39;t execute this code again,</span></div>
<div class="line">            <span class="comment">//until a new suspend condition is detected.</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">//Section 7.1.7.7 of the USB 2.0 specifications indicates a USB</span></div>
<div class="line">            <span class="comment">//device must continuously see 5ms+ of idle on the bus, before it sends</span></div>
<div class="line">            <span class="comment">//remote wakeup signalling.  One way to be certain that this parameter</span></div>
<div class="line">            <span class="comment">//gets met, is to add a 2ms+ blocking delay here (2ms plus at</span></div>
<div class="line">            <span class="comment">//least 3ms from bus idle to USBIsBusSuspended() == TRUE, yeilds</span></div>
<div class="line">            <span class="comment">//5ms+ total delay since start of idle).</span></div>
<div class="line">            delay_count = 3600U;</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                delay_count--;</div>
<div class="line">            } <span class="keywordflow">while</span> (delay_count);</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Now drive the resume K-state signalling onto the USB bus.</span></div>
<div class="line">            USBResumeControl = 1; <span class="comment">// Start RESUME signaling</span></div>
<div class="line">            delay_count = 1800U; <span class="comment">// Set RESUME line for 1-13 ms</span></div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                delay_count--;</div>
<div class="line">            } <span class="keywordflow">while</span> (delay_count);</div>
<div class="line">            USBResumeControl = 0; <span class="comment">//Finished driving resume signalling</span></div>
<div class="line"></div>
<div class="line">            USBUnmaskInterrupts();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(ENABLE_EP0_DATA_RECEIVED_CALLBACK)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordtype">void</span> USBCBEP0DataReceived(<span class="keywordtype">void</span>) {</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line">BOOL USER_USB_CALLBACK_EVENT_HANDLER(<span class="keywordtype">int</span> event, <span class="keywordtype">void</span> *pdata, WORD size)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span>( event )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_TRANSFER:</div>
<div class="line">            <span class="comment">//Add application specific callback task or callback function here if desired.</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_SOF:</div>
<div class="line">            USBCB_SOF_Handler();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_SUSPEND:</div>
<div class="line">            USBCBSuspend();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_RESUME:</div>
<div class="line">            USBCBWakeFromSuspend();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_CONFIGURED:</div>
<div class="line">            USBCBInitEP();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_SET_DESCRIPTOR:</div>
<div class="line">            USBCBStdSetDscHandler();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_EP0_REQUEST:</div>
<div class="line">            USBCBCheckOtherReq();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_BUS_ERROR:</div>
<div class="line">            USBCBErrorHandler();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_TRANSFER_TERMINATED:</div>
<div class="line">            <span class="comment">//Add application specific callback task or callback function here if desired.</span></div>
<div class="line">            <span class="comment">//The EVENT_TRANSFER_TERMINATED event occurs when the host performs a CLEAR</span></div>
<div class="line">            <span class="comment">//FEATURE (endpoint halt) request on an application endpoint which was </span></div>
<div class="line">            <span class="comment">//previously armed (UOWN was = 1).  Here would be a good place to:</span></div>
<div class="line">            <span class="comment">//1.  Determine which endpoint the transaction that just got terminated was </span></div>
<div class="line">            <span class="comment">//      on, by checking the handle value in the *pdata.</span></div>
<div class="line">            <span class="comment">//2.  Re-arm the endpoint if desired (typically would be the case for OUT </span></div>
<div class="line">            <span class="comment">//      endpoints).</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> TRUE;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Dec 9 2014 15:08:18 for Netcruzer Library API by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
