<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Netcruzer: device_HID_demo1/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Netcruzer
   &#160;<span id="projectnumber">V1.03</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('device__h_i_d_demo1_2main_8c-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">device_HID_demo1/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<h2>===== Description =====</h2>
<div class="fragment"><div class="line">This demo monitors the USB port <span class="keywordflow">for</span> any Debug messages. If anything is received, it replies with <span class="stringliteral">&quot;Hello&quot;</span> <span class="keywordtype">string</span>.</div>
<div class="line">Use the <span class="stringliteral">&quot;Netcruzer USB Terminal&quot;</span> app to send and receive USB Debug messages. It can be downloaded here:</div>
<div class="line">http:<span class="comment">//www.netcruzer.com/usbterminal/</span></div>
</div><!-- fragment --><h2>===== Required Hardware =====</h2>
<p>The project requires a <a href="http://netcruzer.com/sbc66-boards/">SBC66 Netcruzer board</a> with an USB Port (not USB Host).</p>
<h2>===== Building Project =====</h2>
<p>This project is located in the "src/demos/usb/device_HID_demo1" folder of the <a href="http://netcruzer.com/nzdownload/" target="_blank">Netcruzer Download</a>. To compile for Netcruzer Board, open this project in MPLAB X, and select the "Project Configuration" for desired board. For example "SBC66ZL_R1" for the <a href="http://netcruzer.com/sbc66zl.html">SBC66ZL</a> Revision 1 board. For details <a href="http://netcruzer.com/nz/doc/building_projects/" target="_blank">click here</a> A common error is "The system cannot find the path specified". This generally means you don't have the required XC16 compiler version installed. Go to "Project Properties", and select your installed XC16 compiler in the "Project Configuration" section.</p>
<h2>===== Programming Board =====</h2>
<p>After compiling (build), the board can be programmed via the <a href="http://netcruzer.com/nz/doc/update_firmware_usb" target="_blank">USB Bootloader</a> or a <a href="http://netcruzer.com/nz/doc/update_firmware_prog" target="_blank">PIC Programmer</a>. USB Programming is simplified when using the SBC board together with a <a href="http://netcruzer.com/nz/doc/update_firmware_usb_pt66" target="_blank">Prototype Board</a>.</p>
<h2>===== File History =====</h2>
<p>2013-07-22, David H. (DH):</p>
<ul>
<li>Initial version</li>
</ul>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef MAIN_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MAIN_C</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Includes /////////////////////////////////////</span></div>
<div class="line"><span class="preprocessor">#include &quot;HardwareProfile.h&quot;</span>    <span class="comment">//Required for all Netcruzer projects</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// PRIVATE PROTOTYPES ///////////////////////////</span></div>
<div class="line"><span class="keywordtype">void</span> BlinkUSBStatus(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> USBCBSendResume(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> USBInit(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> ProcessIO(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> LEDTask(<span class="keywordtype">void</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">//VARIABLES /////////////////////////////////////</span></div>
<div class="line"><a name="_a0"></a><a class="code" href="union___u_s_b___h_i_d___b_o_o_t_l_o_a_d_e_r___c_o_m_m_a_n_d.html">PacketToFromPC</a> PacketFromPC;            <span class="comment">//64 byte buffer for receiving packets on EP1 OUT from the PC</span></div>
<div class="line"><a class="code" href="union___u_s_b___h_i_d___b_o_o_t_l_o_a_d_e_r___c_o_m_m_a_n_d.html">PacketToFromPC</a> PacketToPC;              <span class="comment">//64 byte buffer for sending packets on EP1 IN to the PC</span></div>
<div class="line"><a class="code" href="union___u_s_b___h_i_d___b_o_o_t_l_o_a_d_e_r___c_o_m_m_a_n_d.html">PacketToFromPC</a> PacketFromPCBuffer;</div>
<div class="line"></div>
<div class="line">USB_HANDLE USBOutHandle = 0;</div>
<div class="line">USB_HANDLE USBInHandle = 0;</div>
<div class="line">BOOL blinkStatusValid = TRUE;</div>
<div class="line"></div>
<div class="line">BYTE usbState;</div>
<div class="line">WORD sysLedMask;    <span class="comment">//Used for LED flashing pattern. Has 1 set bit, and it rotated left every 50ms.</span></div>
<div class="line">WORD sysLedPattern; <span class="comment">//Used for blinking system LED</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    WORD tmrFlashLed = 0;       <span class="comment">//Timer for flashing system LED</span></div>
<div class="line">    DIR_SYSLED = OUTPUT_PIN;    <span class="comment">//Set System LED port as outputs</span></div>
<div class="line">    sysLedMask = 0x0001;</div>
<div class="line">    sysLedPattern = 0x0f0f;     <span class="comment">//Blink</span></div>
<div class="line"></div>
<div class="line">    <a name="a1"></a><a class="code" href="nz__netcruzer_8h.html#a591be19f2f4adb5f84d6e21413b0fcc4">nzsysInitDefault</a>();         <span class="comment">//Default initialization. All ports inputs. All analog features disabled. Tick 1ms</span></div>
<div class="line"></div>
<div class="line">    USBInit();</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #if defined(USB_INTERRUPT)</span></div>
<div class="line"><span class="preprocessor"></span>        USBDeviceAttach();</div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="keywordflow">while</span>(1)</div>
<div class="line">    {</div>
<div class="line">        <a name="a2"></a><a class="code" href="nz__netcruzer_8h.html#ad2f434650d0ff9e33add69c425c41771">nzsysTaskDefault</a>();     <span class="comment">//Main netcruzer task, call in main loop.</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">//Enter every 100ms</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a3"></a><a class="code" href="nz__tick_8h.html#aa0f42d9f39952fe9447d27c21a6d40ab">tickHasExpired</a>(tmrFlashLed)) {</div>
<div class="line">            <a name="a4"></a><a class="code" href="nz__tick_8h.html#a2138d47ebbf6ffc2b938caf12c5d7f29">tickUpdateMS</a>(tmrFlashLed, 100); <span class="comment">//Update timer to expire in 100ms again</span></div>
<div class="line">            LEDTask();</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">        #if defined(USB_POLLING)</span></div>
<div class="line"><span class="preprocessor"></span>      <span class="comment">// Check bus status and service USB interrupts.</span></div>
<div class="line">        USBDeviceTasks(); <span class="comment">// Interrupt or polling method.  If using polling, must call</span></div>
<div class="line">                    <span class="comment">// this function periodically.  This function will take care</span></div>
<div class="line">                    <span class="comment">// of processing and responding to SETUP transactions</span></div>
<div class="line">                    <span class="comment">// (such as during the enumeration process when you first</span></div>
<div class="line">                    <span class="comment">// plug in).  USB hosts require that USB devices should accept</span></div>
<div class="line">                    <span class="comment">// and process SETUP packets in a timely fashion.  Therefore,</span></div>
<div class="line">                    <span class="comment">// when using polling, this function should be called</span></div>
<div class="line">                    <span class="comment">// regularly (such as once every 1.8ms or faster** [see</span></div>
<div class="line">                    <span class="comment">// inline code comments in usb_device.c for explanation when</span></div>
<div class="line">                    <span class="comment">// &quot;or faster&quot; applies])  In most cases, the USBDeviceTasks()</span></div>
<div class="line">                    <span class="comment">// function does not take very long to execute (ex: &lt;100</span></div>
<div class="line">                    <span class="comment">// instruction cycles) before it returns.</span></div>
<div class="line"><span class="preprocessor">        #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line">      <span class="comment">// Application-specific tasks.</span></div>
<div class="line">      <span class="comment">// Application related code may be added here, or in the ProcessIO() function.</span></div>
<div class="line">        ProcessIO();</div>
<div class="line">    }<span class="comment">//end while</span></div>
<div class="line"></div>
<div class="line">}<span class="comment">//end main</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBInit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line"><span class="comment">//        The USB specifications require that USB peripheral devices must never source</span></div>
<div class="line"><span class="comment">//        current onto the Vbus pin.  Additionally, USB peripherals should not source</span></div>
<div class="line"><span class="comment">//        current on D+ or D- when the host/hub is not actively powering the Vbus line.</span></div>
<div class="line"><span class="comment">//        When designing a self powered (as opposed to bus powered) USB peripheral</span></div>
<div class="line"><span class="comment">//        device, the firmware should make sure not to turn on the USB module and D+</span></div>
<div class="line"><span class="comment">//        or D- pull up resistor unless Vbus is actively powered.  Therefore, the</span></div>
<div class="line"><span class="comment">//        firmware needs some means to detect when Vbus is being powered by the host.</span></div>
<div class="line"><span class="comment">//        A 5V tolerant I/O pin can be connected to Vbus (through a resistor), and</span></div>
<div class="line"><span class="comment">//         can be used to detect when Vbus is high (host actively powering), or low</span></div>
<div class="line"><span class="comment">//        (host is shut down or otherwise not supplying power).  The USB firmware</span></div>
<div class="line"><span class="comment">//         can then periodically poll this I/O pin to know when it is okay to turn on</span></div>
<div class="line"><span class="comment">//        the USB module/D+/D- pull up resistor.  When designing a purely bus powered</span></div>
<div class="line"><span class="comment">//        peripheral device, it is not possible to source current on D+ or D- when the</span></div>
<div class="line"><span class="comment">//        host is not actively providing power on Vbus. Therefore, implementing this</span></div>
<div class="line"><span class="comment">//        bus sense feature is optional.  This firmware can be made to use this bus</span></div>
<div class="line"><span class="comment">//        sense feature by making sure &quot;USE_USB_BUS_SENSE_IO&quot; has been defined in the</span></div>
<div class="line"><span class="comment">//        HardwareProfile.h file.</span></div>
<div class="line"><span class="preprocessor">    #if defined(USE_USB_BUS_SENSE_IO)</span></div>
<div class="line"><span class="preprocessor"></span>    tris_usb_bus_sense = <a name="a5"></a><a class="code" href="nz__board_8h.html#a1a806e0533aa476bb6e62b7d22c93572" title="Macros for input and output pins. ">INPUT_PIN</a>; <span class="comment">// See HardwareProfile.h</span></div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">//        If the host PC sends a GetStatus (device) request, the firmware must respond</span></div>
<div class="line"><span class="comment">//        and let the host know if the USB peripheral device is currently bus powered</span></div>
<div class="line"><span class="comment">//        or self powered.  See chapter 9 in the official USB specifications for details</span></div>
<div class="line"><span class="comment">//        regarding this request.  If the peripheral device is capable of being both</span></div>
<div class="line"><span class="comment">//        self and bus powered, it should not return a hard coded value for this request.</span></div>
<div class="line"><span class="comment">//        Instead, firmware should check if it is currently self or bus powered, and</span></div>
<div class="line"><span class="comment">//        respond accordingly.  If the hardware has been configured like demonstrated</span></div>
<div class="line"><span class="comment">//        on the PICDEM FS USB Demo Board, an I/O pin can be polled to determine the</span></div>
<div class="line"><span class="comment">//        currently selected power source.  On the PICDEM FS USB Demo Board, &quot;RA2&quot;</span></div>
<div class="line"><span class="comment">//        is used for        this purpose.  If using this feature, make sure &quot;USE_SELF_POWER_SENSE_IO&quot;</span></div>
<div class="line"><span class="comment">//        has been defined in HardwareProfile.h, and that an appropriate I/O pin has been mapped</span></div>
<div class="line"><span class="comment">//        to it in HardwareProfile.h.</span></div>
<div class="line"><span class="preprocessor">    #if defined(USE_SELF_POWER_SENSE_IO)</span></div>
<div class="line"><span class="preprocessor"></span>    tris_self_power = <a class="code" href="nz__board_8h.html#a1a806e0533aa476bb6e62b7d22c93572" title="Macros for input and output pins. ">INPUT_PIN</a>;        <span class="comment">// See HardwareProfile.h</span></div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    <span class="comment">//initialize the variable holding the handle for the last transmission</span></div>
<div class="line">    USBOutHandle = 0;</div>
<div class="line">    USBInHandle = 0;</div>
<div class="line"></div>
<div class="line">    USBDeviceInit();        <span class="comment">//usb_device.c.  Initializes USB module SFRs and firmware variables to known states.</span></div>
<div class="line"></div>
<div class="line">    blinkStatusValid = TRUE;</div>
<div class="line">    usbState = IDLE_STATE;</div>
<div class="line">}<span class="comment">//end</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> LEDTask(<span class="keywordtype">void</span>) {</div>
<div class="line">    sysLedMask = sysLedMask &lt;&lt; 1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (sysLedMask == 0) {</div>
<div class="line">        sysLedMask = 0x0001;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> ( sysLedPattern &amp; sysLedMask) {</div>
<div class="line">        OUT_SYSLED = 1;  <span class="comment">// Turn the LED on</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        OUT_SYSLED = 0;  <span class="comment">// Turn the LED off</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> ProcessIO(<span class="keywordtype">void</span>) {</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Blink the LEDs according to the USB device status</span></div>
<div class="line">    <span class="keywordflow">if</span>(blinkStatusValid)</div>
<div class="line">    {</div>
<div class="line">        BlinkUSBStatus();</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// User Application USB tasks</span></div>
<div class="line">    <span class="keywordflow">if</span>((USBDeviceState &lt; CONFIGURED_STATE) || USBIsDeviceSuspended()) <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Are we done sending the last response.  We need to be seeing that we might have to send</span></div>
<div class="line">    <span class="comment">//a reply to host depending on what we receive</span></div>
<div class="line">    <span class="keywordflow">if</span>(!HIDTxHandleBusy(USBInHandle))</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>(!HIDRxHandleBusy(USBOutHandle))                <span class="comment">//Did we receive a command?</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">switch</span>(PacketFromPC.<a name="a6"></a>Command)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">case</span> CMDUSB_DEVICE_INFO:</div>
<div class="line">                    PacketToPC.Command = PacketFromPC.Command;  <span class="comment">//Build reply message</span></div>
<div class="line">                    PacketToPC.<a name="a7"></a>DeviceInfo.<a name="a8"></a>BoardID = USBHID_BOARD_ID_MAIN;</div>
<div class="line">                    PacketToPC.DeviceInfo.<a name="a9"></a>BoardRev = USBHID_BOARD_REV;</div>
<div class="line"></div>
<div class="line">                    USBInHandle = HIDTxPacket(HID_EP,(BYTE*)&amp;PacketToPC.<a name="a10"></a>Contents[0],64);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                <span class="keywordflow">case</span> CMDUSB_DEBUG_MESSAGE:</div>
<div class="line">                    PacketToPC.Command = PacketFromPC.Command;  <span class="comment">//Build reply message</span></div>
<div class="line">                    PacketToPC.<a name="a11"></a>Size = 6;</div>
<div class="line">                    PacketToPC.<a name="a12"></a>Data[0] = <span class="charliteral">&#39;H&#39;</span>;</div>
<div class="line">                    PacketToPC.Data[1] = <span class="charliteral">&#39;e&#39;</span>;</div>
<div class="line">                    PacketToPC.Data[2] = <span class="charliteral">&#39;l&#39;</span>;</div>
<div class="line">                    PacketToPC.Data[3] = <span class="charliteral">&#39;l&#39;</span>;</div>
<div class="line">                    PacketToPC.Data[4] = <span class="charliteral">&#39;o&#39;</span>;</div>
<div class="line">                    PacketToPC.Data[5] = 0;     <span class="comment">//NULL terminate string</span></div>
<div class="line"></div>
<div class="line">                    USBInHandle = HIDTxPacket(HID_EP,(BYTE*)&amp;PacketToPC.Contents[0],64);</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Re-arm the OUT endpoint for the next packet</span></div>
<div class="line">            USBOutHandle = HIDRxPacket(HID_EP,(BYTE*)&amp;PacketFromPC,64);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> BlinkUSBStatus(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//USB Suspended</span></div>
<div class="line">    <span class="keywordflow">if</span>(USBIsDeviceSuspended())</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//sysLedPattern = 0b0001111100010101;     //1 long, 3 short flash</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//If USB is ready and plugged in, 1 long and 2 short flases</span></div>
<div class="line">        <span class="comment">//Else, 1 long and 1 short flash</span></div>
<div class="line">        <span class="keywordflow">if</span>(USBDeviceState == CONFIGURED_STATE)</div>
<div class="line">        {</div>
<div class="line">            sysLedPattern = 0b0000111110000101;     <span class="comment">//1 long, 2 short flash</span></div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            sysLedPattern = 0b0000011111000001;     <span class="comment">//1 long, 1 short flash</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}<span class="comment">//end BlinkUSBStatus</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// ******************************************************************************************************</span></div>
<div class="line"><span class="comment">// ************** USB Callback Functions ****************************************************************</span></div>
<div class="line"><span class="comment">// ******************************************************************************************************</span></div>
<div class="line"><span class="comment">// The USB firmware stack will call the callback functions USBCBxxx() in response to certain USB related</span></div>
<div class="line"><span class="comment">// events.  For example, if the host PC is powering down, it will stop sending out Start of Frame (SOF)</span></div>
<div class="line"><span class="comment">// packets to your device.  In response to this, all USB devices are supposed to decrease their power</span></div>
<div class="line"><span class="comment">// consumption from the USB Vbus to &lt;2.5mA each.  The USB module detects this condition (which according</span></div>
<div class="line"><span class="comment">// to the USB specifications is 3+ms of no bus activity/SOF packets) and then calls the USBCBSuspend()</span></div>
<div class="line"><span class="comment">// function.  You should modify these callback functions to take appropriate actions for each of these</span></div>
<div class="line"><span class="comment">// conditions.  For example, in the USBCBSuspend(), you may wish to add code that will decrease power</span></div>
<div class="line"><span class="comment">// consumption from Vbus to &lt;2.5mA (such as by clock switching, turning off LEDs, putting the</span></div>
<div class="line"><span class="comment">// microcontroller to sleep, etc.).  Then, in the USBCBWakeFromSuspend() function, you may then wish to</span></div>
<div class="line"><span class="comment">// add code that undoes the power saving things done in the USBCBSuspend() function.</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// The USBCBSendResume() function is special, in that the USB stack will not automatically call this</span></div>
<div class="line"><span class="comment">// function.  This function is meant to be called from the application firmware instead.  See the</span></div>
<div class="line"><span class="comment">// additional comments near the function.</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBSuspend(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">//Example power saving code.  Insert appropriate code here for the desired</span></div>
<div class="line">    <span class="comment">//application behavior.  If the microcontroller will be put to sleep, a</span></div>
<div class="line">    <span class="comment">//process similar to that shown below may be used:</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//ConfigureIOPinsForLowPower();</span></div>
<div class="line">    <span class="comment">//SaveStateOfAllInterruptEnableBits();</span></div>
<div class="line">    <span class="comment">//DisableAllInterruptEnableBits();</span></div>
<div class="line">    <span class="comment">//EnableOnlyTheInterruptsWhichWillBeUsedToWakeTheMicro();        //should enable at least USBActivityIF as a wake source</span></div>
<div class="line">    <span class="comment">//Sleep();</span></div>
<div class="line">    <span class="comment">//RestoreStateOfAllPreviouslySavedInterruptEnableBits();        //Preferrably, this should be done in the USBCBWakeFromSuspend() function instead.</span></div>
<div class="line">    <span class="comment">//RestoreIOPinsToNormal();                                                                        //Preferrably, this should be done in the USBCBWakeFromSuspend() function instead.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//IMPORTANT NOTE: Do not clear the USBActivityIF (ACTVIF) bit here.  This bit is</span></div>
<div class="line">    <span class="comment">//cleared inside the usb_device.c file.  Clearing USBActivityIF here will cause</span></div>
<div class="line">    <span class="comment">//things to not work as intended.</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    #if defined(__C30__)</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">//USBSleepOnSuspend();      //Need to include usb_hal_pic24.c if this function is enabled.</span></div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBWakeFromSuspend(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// If clock switching or other power savings measures were taken when</span></div>
<div class="line">    <span class="comment">// executing the USBCBSuspend() function, now would be a good time to</span></div>
<div class="line">    <span class="comment">// switch back to normal full power run mode conditions.  The host allows</span></div>
<div class="line">    <span class="comment">// a few milliseconds of wakeup time, after which the device must be</span></div>
<div class="line">    <span class="comment">// fully back to normal, and capable of receiving and processing USB</span></div>
<div class="line">    <span class="comment">// packets.  In order to do this, the USB module must receive proper</span></div>
<div class="line">    <span class="comment">// clocking (IE: 48MHz clock must be available to SIE for full speed USB</span></div>
<div class="line">    <span class="comment">// operation).</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCB_SOF_Handler(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// No need to clear UIRbits.SOFIF to 0 here.</span></div>
<div class="line">    <span class="comment">// Callback caller is already doing that.</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBErrorHandler(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">// No need to clear UEIR to 0 here.</span></div>
<div class="line">    <span class="comment">// Callback caller is already doing that.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Typically, user firmware does not need to do anything special</span></div>
<div class="line">    <span class="comment">// if a USB error occurs.  For example, if the host sends an OUT</span></div>
<div class="line">    <span class="comment">// packet to your device, but the packet gets corrupted (ex:</span></div>
<div class="line">    <span class="comment">// because of a bad connection, or the user unplugs the</span></div>
<div class="line">    <span class="comment">// USB cable during the transmission) this will typically set</span></div>
<div class="line">    <span class="comment">// one or more USB error interrupt flags.  Nothing specific</span></div>
<div class="line">    <span class="comment">// needs to be done however, since the SIE will automatically</span></div>
<div class="line">    <span class="comment">// send a &quot;NAK&quot; packet to the host.  In response to this, the</span></div>
<div class="line">    <span class="comment">// host will normally retry to send the packet again, and no</span></div>
<div class="line">    <span class="comment">// data loss occurs.  The system will typically recover</span></div>
<div class="line">    <span class="comment">// automatically, without the need for application firmware</span></div>
<div class="line">    <span class="comment">// intervention.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Nevertheless, this callback function is provided, such as</span></div>
<div class="line">    <span class="comment">// for debugging purposes.</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBCheckOtherReq(<span class="keywordtype">void</span>) {</div>
<div class="line"><span class="preprocessor">    #if defined(USB_IS_CDC)</span></div>
<div class="line"><span class="preprocessor"></span>        USBCheckCDCRequest();</div>
<div class="line"><span class="preprocessor">    #elif defined(USB_IS_HID)</span></div>
<div class="line"><span class="preprocessor"></span>        USBCheckHIDRequest();</div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span>}<span class="comment">//end</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBStdSetDscHandler(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">// Must claim session ownership if supporting this request</span></div>
<div class="line">}<span class="comment">//end</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBInitEP(<span class="keywordtype">void</span>) {</div>
<div class="line"><span class="preprocessor">    #if defined(USB_IS_CDC)</span></div>
<div class="line"><span class="preprocessor"></span>        CDCInitEP();</div>
<div class="line"><span class="preprocessor">    #elif defined(USB_IS_HID)</span></div>
<div class="line"><span class="preprocessor"></span>        <span class="comment">//enable the HID endpoint</span></div>
<div class="line">        USBEnableEndpoint(HID_EP,USB_IN_ENABLED|USB_OUT_ENABLED|USB_HANDSHAKE_ENABLED|USB_DISALLOW_SETUP);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Arm the OUT endpoint for the first packet</span></div>
<div class="line">        <span class="comment">//USBOutHandle = HIDRxPacket(HID_EP,(BYTE*)&amp;PacketFromPCBuffer,64);</span></div>
<div class="line">        USBOutHandle = HIDRxPacket(HID_EP,(BYTE*)&amp;PacketFromPC,64);</div>
<div class="line"><span class="preprocessor">    #endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> USBCBSendResume(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keyword">static</span> WORD delay_count;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//First verify that the host has armed us to perform remote wakeup.</span></div>
<div class="line">    <span class="comment">//It does this by sending a SET_FEATURE request to enable remote wakeup,</span></div>
<div class="line">    <span class="comment">//usually just before the host goes to standby mode (note: it will only</span></div>
<div class="line">    <span class="comment">//send this SET_FEATURE request if the configuration descriptor declares</span></div>
<div class="line">    <span class="comment">//the device as remote wakeup capable, AND, if the feature is enabled</span></div>
<div class="line">    <span class="comment">//on the host (ex: on Windows based hosts, in the device manager</span></div>
<div class="line">    <span class="comment">//properties page for the USB device, power management tab, the</span></div>
<div class="line">    <span class="comment">//&quot;Allow this device to bring the computer out of standby.&quot; checkbox</span></div>
<div class="line">    <span class="comment">//should be checked).</span></div>
<div class="line">    <span class="keywordflow">if</span> (USBGetRemoteWakeupStatus() == TRUE) {</div>
<div class="line">        <span class="comment">//Verify that the USB bus is in fact suspended, before we send</span></div>
<div class="line">        <span class="comment">//remote wakeup signalling.</span></div>
<div class="line">        <span class="keywordflow">if</span> (USBIsBusSuspended() == TRUE) {</div>
<div class="line">            USBMaskInterrupts();</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Clock switch to settings consistent with normal USB operation.</span></div>
<div class="line">            USBCBWakeFromSuspend();</div>
<div class="line">            USBSuspendControl = 0;</div>
<div class="line">            USBBusIsSuspended = FALSE; <span class="comment">//So we don&#39;t execute this code again,</span></div>
<div class="line">            <span class="comment">//until a new suspend condition is detected.</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">//Section 7.1.7.7 of the USB 2.0 specifications indicates a USB</span></div>
<div class="line">            <span class="comment">//device must continuously see 5ms+ of idle on the bus, before it sends</span></div>
<div class="line">            <span class="comment">//remote wakeup signalling.  One way to be certain that this parameter</span></div>
<div class="line">            <span class="comment">//gets met, is to add a 2ms+ blocking delay here (2ms plus at</span></div>
<div class="line">            <span class="comment">//least 3ms from bus idle to USBIsBusSuspended() == TRUE, yeilds</span></div>
<div class="line">            <span class="comment">//5ms+ total delay since start of idle).</span></div>
<div class="line">            delay_count = 3600U;</div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                delay_count--;</div>
<div class="line">            } <span class="keywordflow">while</span> (delay_count);</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Now drive the resume K-state signalling onto the USB bus.</span></div>
<div class="line">            USBResumeControl = 1; <span class="comment">// Start RESUME signaling</span></div>
<div class="line">            delay_count = 1800U; <span class="comment">// Set RESUME line for 1-13 ms</span></div>
<div class="line">            <span class="keywordflow">do</span> {</div>
<div class="line">                delay_count--;</div>
<div class="line">            } <span class="keywordflow">while</span> (delay_count);</div>
<div class="line">            USBResumeControl = 0; <span class="comment">//Finished driving resume signalling</span></div>
<div class="line"></div>
<div class="line">            USBUnmaskInterrupts();</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(ENABLE_EP0_DATA_RECEIVED_CALLBACK)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordtype">void</span> USBCBEP0DataReceived(<span class="keywordtype">void</span>) {</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line">BOOL USER_USB_CALLBACK_EVENT_HANDLER(<span class="keywordtype">int</span> event, <span class="keywordtype">void</span> *pdata, WORD size)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">switch</span>(event)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_TRANSFER:</div>
<div class="line">            <span class="comment">//Add application specific callback task or callback function here if desired.</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_SOF:</div>
<div class="line">            USBCB_SOF_Handler();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_SUSPEND:</div>
<div class="line">            USBCBSuspend();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_RESUME:</div>
<div class="line">            USBCBWakeFromSuspend();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_CONFIGURED:</div>
<div class="line">            USBCBInitEP();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_SET_DESCRIPTOR:</div>
<div class="line">            USBCBStdSetDscHandler();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_EP0_REQUEST:</div>
<div class="line">            USBCBCheckOtherReq();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_BUS_ERROR:</div>
<div class="line">            USBCBErrorHandler();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> EVENT_TRANSFER_TERMINATED:</div>
<div class="line">            <span class="comment">//Add application specific callback task or callback function here if desired.</span></div>
<div class="line">            <span class="comment">//The EVENT_TRANSFER_TERMINATED event occurs when the host performs a CLEAR</span></div>
<div class="line">            <span class="comment">//FEATURE (endpoint halt) request on an application endpoint which was</span></div>
<div class="line">            <span class="comment">//previously armed (UOWN was = 1).  Here would be a good place to:</span></div>
<div class="line">            <span class="comment">//1.  Determine which endpoint the transaction that just got terminated was</span></div>
<div class="line">            <span class="comment">//      on, by checking the handle value in the *pdata.</span></div>
<div class="line">            <span class="comment">//2.  Re-arm the endpoint if desired (typically would be the case for OUT</span></div>
<div class="line">            <span class="comment">//      endpoints).</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> TRUE;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Aug 5 2013 10:16:20 for Netcruzer by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
