<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Netcruzer Library API: ow_ds2482_async_debug/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Netcruzer Library API
   &#160;<span id="projectnumber">V2.03</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ow_ds2482_async_debug_2main_8c-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ow_ds2482_async_debug/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<h2>===== Description =====</h2>
<p>This demo shows how to communicate with the DS2482 1-Wire interface chip, using the nz_ds2482.h and nz_ds2482.c driver. It uses non-blocking (asynchronous) DS2482 functions. These functions are more complex to implement than the blocking version, but never cause delays blocking all other code from executing. All blocking function names end with "WATE" (WAiT and Error processing). For example, the blocking version of the owReadByte() function is owReadByteWATE().</p>
<p>It also flashes the system LED. To add DS2482 support to a project, the following must be done:</p>
<ul>
<li>Add nz_ds2482.c to the project, this is the main DS2482 driver file.</li>
<li>The following additional files are required by nz_ds2482.c, and must be added to the project: nz_circularBufferPwr2.c, nz_helpers.c, nz_netcruzer.c and nz_serI2C.c</li>
<li>Add "NZ_I2C1_ENABLE" to projdefs.h file (assuming the DS2482 is on I2C 1).</li>
<li>In code, create a DS2482_INFO structure for each DS2482, and initialize. For example: DS2482_INFO objDS2482; ds2482_init(&amp;objDS2482, 1, DS2482_ADDRESS_00); //Initialize using I2C 1, and DS2482 AD0 and AD1 = 0</li>
<li>In projdefs.h, do any DS2482, I2C or other configuration required. This is done by copying the configuration section from the *.h files to projdefs.h. Nothing required, defaults will work!</li>
<li>All done! Can now use ds2482.h driver functions! For example, to write a byte to the 1-Wire Network: owWriteByteWATE(&amp;objDS2482, 0xCC); //Write Skip ROM = 0xCC</li>
</ul>
<p>This demo can be used with any <a href="http://netcruzer.com/products-sbc66-main/">SBC66 Netcruzer board</a> with an USB Port (not USB Host). It uses USB Commands and Debug Messages sent and received via the <a href="http://www.netcruzer.com/usbterminal/">Netcruzer USB Terminal</a> app to communicate with board.</p>
<p>Additionally this demo also implements debugging via the USB port and the <a href="http://www.netcruzer.com/usbterminal/">Netcruzer USB Terminal</a> App. During the program various debug messages are written, which will be displayed on the "Netcruzer USB Terminal" (running on a PC connected to the target board's USB port). This demo also monitors the USB port for Debug messages send to us. <br/>
- If "hi" is received, it replies with "Hello" <br/>
Use the "Netcruzer USB Terminal" App to send and receive USB Debug messages. It can be downloaded here: <a href="http://www.netcruzer.com/usbterminal/">http://www.netcruzer.com/usbterminal/</a></p>
<h2>===== Required Hardware =====</h2>
<p>The project requires a <a href="http://netcruzer.com/products-sbc66-main/">SBC66 Netcruzer board</a> with an USB Port (not USB Host), like the <a href="http://netcruzer.com/sbc66zl/">SBC66ZL</a> for example. Additionally a DS2482 1-Wire to I2C Bridge chip has to be connected to the I2C 1 port of the SBC66 board. We recommend using one of our <a href="http://www.netcruzer.com/products-sbc66-prototype">Prototype Boards</a> with an iMod port ( <a href="http://www.netcruzer.com/pt66eci.html">PT66ECI</a> for example), and our <a href="http://www.netcruzer.com/products-imod-1wire">im1WP</a> 1-Wire DS2482 Interface Module.</p>
<h2>===== Building Project =====</h2>
<p>This project is located in the "src/demos/1wire/ow_ds2482_async_debug" folder of the <a href="http://netcruzer.com/nzdownload/" target="_blank">Netcruzer Download</a>. To compile for Netcruzer Board, open this project in MPLAB X, and select the "Project Configuration" for desired board. For example "SBC66ZL_R1" for the <a href="http://netcruzer.com/sbc66zl.html">SBC66ZL</a> Revision 1 board. For details <a href="http://netcruzer.com/nz/doc/building_projects/" target="_blank">click here</a></p>
<h2>===== Programming Board =====</h2>
<p>After compiling (build), the board can be programmed via the <a href="http://netcruzer.com/nz/doc/update_firmware_usb" target="_blank">USB Bootloader</a> or a <a href="http://netcruzer.com/nz/doc/update_firmware_prog" target="_blank">PIC Programmer</a>. USB Programming is simplified when using the SBC board together with a <a href="http://netcruzer.com/nz/doc/update_firmware_usb_pt66" target="_blank">Prototype Board</a>.</p>
<h2>===== File History =====</h2>
<p>2013-10-31, David H. (DH):</p>
<ul>
<li>Initial version</li>
</ul>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#define THIS_IS_MAIN_FILE   //Uniquely identifies this as the file with the main application entry function main()</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Includes /////////////////////////////////////</span></div>
<div class="line"><span class="preprocessor">#include &quot;HardwareProfile.h&quot;</span>    <span class="comment">//Required for all Netcruzer projects</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="nz__ow2482_8h.html" title="Functions for DS2482 1-Wire interface. ">nz_ow2482.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="nz__ser_i2_c_8h.html" title="I2C Port 1 functions. ">nz_serI2C.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="nz__helpers_8h.html" title="Netcruzer Helper Functions. ">nz_helpers.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//Add debugging. DEBUG_CONF_MAIN macro sets debugging to desired level (defined in projdefs.h)</span></div>
<div class="line"><span class="preprocessor">#if !defined(DEBUG_CONF_MAIN)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define DEBUG_CONF_MAIN     DEBUG_CONF_DEFAULT   //Default Debug Level, disabled if DEBUG_LEVEL_ALLOFF defined, else DEBUG_LEVEL_ERROR</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MY_DEBUG_LEVEL   DEBUG_CONF_MAIN</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="nz__debug_8h.html" title="This file defines a Debug interface. ">nz_debug.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Defines //////////////////////////////////////</span></div>
<div class="line"><span class="preprocessor">#define DS18B20_PARASITIC_POWER</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Variables ////////////////////////////////////</span></div>
<div class="line">DS2482_INFO objDS2482;</div>
<div class="line">WORD tmrFlashLed;   <span class="comment">//Timer for flashing system LED</span></div>
<div class="line"><span class="preprocessor">#define DS2482 (&amp;objDS2482)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Function Prototypes //////////////////////////</span></div>
<div class="line">BYTE ds18b20_task(DS2482_INFO* pObj);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line">    tmrFlashLed = <a name="a0"></a><a class="code" href="nz__tick_8h.html#a1488f07fe5f1db9ec750bba8d7347759">tick16Get</a>();    <span class="comment">//Timer for flashing system LED</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Default initialization. All ports inputs. All analog features disabled. Tick 1ms</span></div>
<div class="line">    <a name="a1"></a><a class="code" href="nz__netcruzer_8h.html#adfed4b7fa101ade26bd57d654f4c7bcd">nzSysInitDefault</a>();</div>
<div class="line"></div>
<div class="line">    <a name="a2"></a><a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nThis is a test debug message from ow_ds2482_async_debug&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Set System LED port as outputs. Setting a DIR_xxx bit to 1 set&#39;s corresponding port to input, and 0 as output</span></div>
<div class="line">    DIR_SYSLED = OUTPUT_PIN;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//DS2482 Initialization</span></div>
<div class="line">    ds2482_init(DS2482, 1, DS2482_ADDRESS_00); <span class="comment">//Initialize DS2482, using I2C 1, and DS2482 AD0 and AD1 = 0</span></div>
<div class="line">    </div>
<div class="line">    delay_ms(20);   <span class="comment">//Wait for DS18B20 to settle</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">//Main loop</span></div>
<div class="line">    <span class="keywordflow">while</span>(1)</div>
<div class="line">    {</div>
<div class="line">        <a name="a3"></a><a class="code" href="nz__netcruzer_8h.html#ad9122988f6a0fb44a89afca419b66e65">nzSysTaskDefault</a>();     <span class="comment">//Main netcruzer task, call in main loop.</span></div>
<div class="line"></div>
<div class="line">        ds18b20_task(DS2482);   <span class="comment">//Read and display Temperature using non-blocking functions</span></div>
<div class="line">        </div>
<div class="line">        ds2482_task(DS2482);    <span class="comment">//DS2482 Task</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a4"></a><a class="code" href="nz__tick_8h.html#a6ba5b7c684a01befa0d9522a7efa880a">tick16TestTmr</a>(tmrFlashLed)) {</div>
<div class="line">            <a name="a5"></a><a class="code" href="nz__tick_8h.html#abd9d8cafb5bb9c655365cebd7bc2bd56">tick16UpdateTmrMS</a>(tmrFlashLed, 500); <span class="comment">//Update timer to expire in 500ms again</span></div>
<div class="line">            LAT_SYSLED = !LAT_SYSLED; <span class="comment">//Toggle System LED</span></div>
<div class="line">        }</div>
<div class="line">    }<span class="comment">//end while</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">BYTE ds18b20_task(DS2482_INFO* pObj) {</div>
<div class="line"><span class="preprocessor">    #define MAX_DEVICES 4</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">static</span> BYTE deviceAdr[MAX_DEVICES][8];</div>
<div class="line">    <span class="keyword">static</span> BYTE <span class="keyword">get</span>[10];</div>
<div class="line">    <span class="keyword">static</span> BYTE devices;    <span class="comment">//Count how many devices found</span></div>
<div class="line">    <span class="keyword">static</span> WORD_VAL temp;</div>
<div class="line">    <span class="keyword">static</span> WORD tmrDelay;</div>
<div class="line">    <span class="keyword">static</span> BYTE iRd=0;</div>
<div class="line">    <span class="keyword">static</span> BYTE idx=0;</div>
<div class="line">    <span class="keywordtype">double</span> fTemp;</div>
<div class="line"></div>
<div class="line">    <span class="keyword">typedef</span> <span class="keyword">enum</span> SM_PRINT_DS18B20_ {</div>
<div class="line">        SM_PRTDS_IDLE = 0,</div>
<div class="line">        SM_PRTDS_SEARCH,</div>
<div class="line">        SM_PRTDS_SEARCH_DONE,</div>
<div class="line">        SM_PRTDS_NEXT_DEVICE,</div>
<div class="line">        SM_PRTDS_NEXT_DEVICE_SELECT,</div>
<div class="line">        SM_PRTDS_NEXT_DEVICE_START_CONVERSION,</div>
<div class="line">        SM_PRTDS_NEXT_DEVICE_START_CONVERSION_DELAY,</div>
<div class="line">        SM_PRTDS_NEXT_DEVICE_SELECT2,</div>
<div class="line">        SM_PRTDS_NEXT_DEVICE_RD_SCRATCH_PAD,</div>
<div class="line">        SM_PRTDS_READ_DS18B20_BYTES,</div>
<div class="line">        SM_PRTDS_READ_DS18B20_BYTES2,</div>
<div class="line">        SM_PRTDS_DONE,</div>
<div class="line">    } SM_PRINT_DS18B20;</div>
<div class="line">    <span class="keyword">static</span> SM_PRINT_DS18B20 sm_prtds = SM_PRTDS_IDLE;</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    #define SM_PRTDS_WAIT_FOR_TXION 0x80    //Wait for DS2482 Transmission - use upper bit 7</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    #define SM_PRTDS_SM_MASK        0x7F    //Mask out all bits above</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">//Wait for current DS2482 Transmission to finish, and get status</span></div>
<div class="line">    <span class="keywordflow">if</span> (sm_prtds &amp; SM_PRTDS_WAIT_FOR_TXION) {</div>
<div class="line">        <span class="comment">//DS2482 is still busy, return!</span></div>
<div class="line">        <span class="keywordflow">if</span> (ds2482_isBusy(pObj) == TRUE)</div>
<div class="line">            <span class="keywordflow">return</span> 1;                   <span class="comment">//Return not done - waiting</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//Check if last transmission status is an Error!</span></div>
<div class="line">        <span class="keywordflow">if</span> (ds2482_getStatus(pObj) != 0) {</div>
<div class="line">            <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_WARNING, <span class="stringliteral">&quot;\nprintAllAsync_DS18B20 Error!&quot;</span>);</div>
<div class="line">            sm_prtds = SM_PRTDS_IDLE;   <span class="comment">//Return to idle state</span></div>
<div class="line">            <span class="keywordflow">return</span> 0;                   <span class="comment">//Return done</span></div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//Status was just received! Clear SM_TASK_WAIT_1WB flag</span></div>
<div class="line">       sm_prtds = sm_prtds &amp; ~SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//State machine</span></div>
<div class="line">    <span class="keywordflow">switch</span> (sm_prtds &amp; SM_PRTDS_SM_MASK) {</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_IDLE:</div>
<div class="line">            <span class="comment">//Reset search</span></div>
<div class="line">            devices = 0;</div>
<div class="line">            owSearchReset(pObj);</div>
<div class="line">            sm_prtds++; <span class="comment">//Increment to next state</span></div>
<div class="line">            <span class="comment">//break;    //NO BREAK! Fall thru to next state</span></div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_SEARCH:</div>
<div class="line">            <span class="comment">//Search for devices, and store the addresses of all DS18B20 devices in deviceAdr[][]</span></div>
<div class="line">            <span class="keywordflow">if</span> (owSearch(pObj) != 0)</div>
<div class="line">                <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">            <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">            sm_prtds = SM_PRTDS_SEARCH_DONE | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_SEARCH_DONE:</div>
<div class="line">            <span class="comment">//A 1-Wire device was found (owGetAdr64() returns owSearch() result)</span></div>
<div class="line">            <span class="keywordflow">if</span> (owGetAdr64(pObj) != 0) {</div>
<div class="line">                <span class="comment">//Is it a DS18B20, the LSB of the ROM Address</span></div>
<div class="line">                <span class="keywordflow">if</span> (pObj-&gt;adr64[0] == 0x28) {</div>
<div class="line">                    <span class="comment">//Device found, save and print it&#39;s address</span></div>
<div class="line">                    <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nDS18B20 Found: &quot;</span>);</div>
<div class="line">                    <span class="keywordflow">for</span> (iRd=0; iRd&lt;8; iRd++) {</div>
<div class="line">                        <span class="comment">//Save and display address</span></div>
<div class="line">                        deviceAdr[devices][iRd]=pObj-&gt;adr64[iRd];</div>
<div class="line">                        <a name="a6"></a><a class="code" href="nz__debug_8h.html#a5ac2c457e562cc1c5f67214a6a841758">DEBUG_PUT_HEXBYTE</a>(DEBUG_LEVEL_INFO, pObj-&gt;adr64[iRd]);</div>
<div class="line">                    }</div>
<div class="line">                    <span class="comment">//Check if deviceAdr[][] array is full, and break out of loop</span></div>
<div class="line">                    <span class="keywordflow">if</span> (devices == (MAX_DEVICES-1)) {</div>
<div class="line">                        <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nFound maximum supported number of devices&quot;</span>);</div>
<div class="line">                        <span class="keywordflow">break</span>;</div>
<div class="line">                    }</div>
<div class="line">                    devices++;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span> {</div>
<div class="line">                    <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nFound unsupported device &quot;</span>);</div>
<div class="line"><span class="preprocessor">                    #if (MY_DEBUG_LEVEL &gt;= DEBUG_LEVEL_INFO)</span></div>
<div class="line"><span class="preprocessor"></span>                    <span class="keywordflow">for</span> (iRd=0; iRd&lt;8; iRd++) {</div>
<div class="line">                        <a class="code" href="nz__debug_8h.html#a5ac2c457e562cc1c5f67214a6a841758">DEBUG_PUT_HEXBYTE</a>(DEBUG_LEVEL_INFO, pObj-&gt;adr64[iRd]);</div>
<div class="line">                    }</div>
<div class="line"><span class="preprocessor">                    #endif</span></div>
<div class="line"><span class="preprocessor"></span>                }</div>
<div class="line">                </div>
<div class="line">                <span class="comment">//Return to &quot;Search State&quot;, and search for next device</span></div>
<div class="line">                sm_prtds = SM_PRTDS_SEARCH;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//All 1-Wire devices have been found, increment to next state</span></div>
<div class="line">            idx = 0;    <span class="comment">//Reset to first device index</span></div>
<div class="line">            sm_prtds++; <span class="comment">//Increment to next state</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_NEXT_DEVICE:</div>
<div class="line">            <span class="comment">//Print temperature for all DS18B20 devices found</span></div>
<div class="line">            <span class="keywordflow">if</span>(idx++ &lt; devices) {</div>
<div class="line">                <span class="comment">//Reset 1-Wire Net, and wait till done</span></div>
<div class="line">                <span class="keywordflow">if</span> (owReset(pObj) != 0)</div>
<div class="line">                    <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">                <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">                sm_prtds = SM_PRTDS_NEXT_DEVICE_SELECT | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">//Done! Printed temperature for all devices!</span></div>
<div class="line">            tmrDelay = <a class="code" href="nz__tick_8h.html#a1488f07fe5f1db9ec750bba8d7347759">tick16Get</a>();</div>
<div class="line">            sm_prtds = SM_PRTDS_DONE;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_NEXT_DEVICE_SELECT:</div>
<div class="line">            <span class="comment">//Select 1-Wire Net, and wait till done</span></div>
<div class="line">            <span class="keywordflow">if</span> (owSelect(pObj, &amp;deviceAdr[idx-1][0]) != 0)</div>
<div class="line">                <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">            <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">            sm_prtds = SM_PRTDS_NEXT_DEVICE_START_CONVERSION | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_NEXT_DEVICE_START_CONVERSION:</div>
<div class="line">            <span class="comment">//Start Conversion (0x44), and wait(in next state) till done</span></div>
<div class="line">            <span class="comment">//If the DS18B20 is in &quot;parasite power&quot; mode (2 wires, no Vcc), than the &quot;Strong</span></div>
<div class="line">            <span class="comment">//pull-up&quot; on the 1-Wire network must be enabled after sending the conversion</span></div>
<div class="line">            <span class="comment">//command. This has to stay active until the conversion is done.</span></div>
<div class="line"><span class="preprocessor">            #if defined(DS18B20_PARASITIC_POWER)</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">if</span> (owWriteBytePower(pObj, 0x44) != 0) {</div>
<div class="line"><span class="preprocessor">            #else</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">if</span> (owWriteByte(pObj, 0x44) != 0) {</div>
<div class="line"><span class="preprocessor">            #endif</span></div>
<div class="line"><span class="preprocessor"></span>                <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">            sm_prtds = SM_PRTDS_NEXT_DEVICE_START_CONVERSION_DELAY | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">            tmrDelay = <a class="code" href="nz__tick_8h.html#a1488f07fe5f1db9ec750bba8d7347759">tick16Get</a>();</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_NEXT_DEVICE_START_CONVERSION_DELAY:</div>
<div class="line">            <span class="comment">//Wait delay required after issuing a &quot;Start Conversion&quot; command till the</span></div>
<div class="line">            <span class="comment">//depends on the bit resolution setting of the DS18B20. The possible delays</span></div>
<div class="line">            <span class="comment">//are:</span></div>
<div class="line">            <span class="comment">// - 94ms for 9 bit resolution</span></div>
<div class="line">            <span class="comment">// - 188ms for 10 bit resolution</span></div>
<div class="line">            <span class="comment">// - 375ms for 11 bit resolution</span></div>
<div class="line">            <span class="comment">// - 750ms for 12 bit resolution</span></div>
<div class="line">            <span class="comment">//Seeing that we have not read the Configuration register to determine the</span></div>
<div class="line">            <span class="comment">//resolution, assume worst case of 12 bit resolution</span></div>
<div class="line">            <span class="comment">//</span></div>
<div class="line">            <span class="comment">//To decrease this delay:</span></div>
<div class="line">            <span class="comment">// - Reduce resolution of DS18B20 devices</span></div>
<div class="line">            <span class="comment">// - Supply the DS18B20 with their own power. In this case I think we can</span></div>
<div class="line">            <span class="comment">//   move on to the next DS18B20 while this one is converting. After issuing</span></div>
<div class="line">            <span class="comment">//   a &quot;Start Conversion&quot; command to all, poll them to see when done.</span></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="nz__tick_8h.html#a6ba5b7c684a01befa0d9522a7efa880a">tick16TestTmr</a>(tmrDelay + <a name="a7"></a><a class="code" href="nz__tick_8h.html#ac2bfad775fe284923976a5c4fd93dfa6">tick16ConvertFromMS</a>(750))) {</div>
<div class="line">                <span class="comment">//Reset 1-Wire Net, and wait till done</span></div>
<div class="line">                <span class="keywordflow">if</span> (owReset(pObj) != 0)</div>
<div class="line">                    <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">                <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">                sm_prtds = SM_PRTDS_NEXT_DEVICE_SELECT2 | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_NEXT_DEVICE_SELECT2:</div>
<div class="line">            <span class="comment">//Select 1-Wire Net, and wait till done</span></div>
<div class="line">            <span class="keywordflow">if</span> (owSelect(pObj, &amp;deviceAdr[idx-1][0]) != 0)</div>
<div class="line">                <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">            <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">            sm_prtds = SM_PRTDS_NEXT_DEVICE_RD_SCRATCH_PAD | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_NEXT_DEVICE_RD_SCRATCH_PAD:</div>
<div class="line">            <span class="comment">//Read Scratch Pad (0xBE), and wait till done</span></div>
<div class="line">            <span class="keywordflow">if</span> (owWriteByte(pObj, 0xBE) != 0)</div>
<div class="line">                <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">            <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">            sm_prtds = SM_PRTDS_READ_DS18B20_BYTES | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">            iRd = 0;</div>
<div class="line">            <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nScratchPAD DATA = 0x&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_READ_DS18B20_BYTES:</div>
<div class="line">            <span class="comment">//Read next byte of DS18B20 scratch memory</span></div>
<div class="line">            <span class="keywordflow">if</span> (owReadByte(pObj) != 0)</div>
<div class="line">                <span class="keywordflow">goto</span> PRINT_ALL_ASYNC_DS18B20_ERROR;</div>
<div class="line">            <span class="comment">//Increment to next state, and set SM_PRTDS_WAIT_FOR_TXION flag (wait for Txion)</span></div>
<div class="line">            sm_prtds = SM_PRTDS_READ_DS18B20_BYTES2 | SM_PRTDS_WAIT_FOR_TXION;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_READ_DS18B20_BYTES2:</div>
<div class="line">            <span class="comment">//Get byte just read</span></div>
<div class="line">            <span class="keyword">get</span>[iRd] = owGetByte(pObj);</div>
<div class="line">            <a class="code" href="nz__debug_8h.html#a5ac2c457e562cc1c5f67214a6a841758">DEBUG_PUT_HEXBYTE</a>(DEBUG_LEVEL_INFO, <span class="keyword">get</span>[iRd]);</div>
<div class="line">            <a name="a8"></a><a class="code" href="nz__debug_8h.html#a1f9eab50f4ceade50e9fe4f33e6f81f5">DEBUG_PUT_CHAR</a>(DEBUG_LEVEL_INFO, <span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">            <span class="comment">//Are there more byte to read? Read all 9 bytes of DS18B20 scratch memory</span></div>
<div class="line">            <span class="keywordflow">if</span>(iRd++ &lt; 9) {</div>
<div class="line">                sm_prtds = SM_PRTDS_READ_DS18B20_BYTES;</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Done reading whole &quot;Scratch Pad&quot; memory! Print temperature for device!</span></div>
<div class="line">            temp.byte.LB = <span class="keyword">get</span>[0];</div>
<div class="line">            temp.byte.HB = <span class="keyword">get</span>[1];</div>
<div class="line">            fTemp = (temp.Val &amp; 0x07f0)&gt;&gt;4;</div>
<div class="line">            fTemp += 0.0625 * (temp.byte.LB &amp; 0x0f);</div>
<div class="line">            <a name="a9"></a><a class="code" href="stdio_8h.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;\nTempC= %f degrees C\n&quot;</span>, fTemp); <span class="comment">// print temp. C</span></div>
<div class="line"></div>
<div class="line">            <span class="comment">//Process next DS18B20 device, loop back to SM_PRTDS_NEXT_DEVICE state</span></div>
<div class="line">            sm_prtds = SM_PRTDS_NEXT_DEVICE;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> SM_PRTDS_DONE:</div>
<div class="line">            <span class="comment">//Wait 1000ms and print all temperatures again</span></div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="nz__tick_8h.html#a6ba5b7c684a01befa0d9522a7efa880a">tick16TestTmr</a>(tmrDelay + <a class="code" href="nz__tick_8h.html#ac2bfad775fe284923976a5c4fd93dfa6">tick16ConvertFromMS</a>(1000))) {</div>
<div class="line">                idx = 0;    <span class="comment">//Reset to first device index</span></div>
<div class="line">                sm_prtds = SM_PRTDS_NEXT_DEVICE;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">//If state = SM_PRTDS_DONE, return 0 (done). Else, not done, return 1;</span></div>
<div class="line">    <span class="keywordflow">return</span> (sm_prtds!=SM_PRTDS_DONE);</div>
<div class="line"></div>
<div class="line">    PRINT_ALL_ASYNC_DS18B20_ERROR:</div>
<div class="line">    sm_prtds = SM_PRTDS_DONE;</div>
<div class="line">    <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_WARNING, <span class="stringliteral">&quot;\nprintAllAsync_DS18B20 Error!&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;   <span class="comment">//Done</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(HAS_NZ_DEBUGGING)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">void</span> debugService(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">//Check if a debug message was received</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a10"></a><a class="code" href="nz__circular_buffer_8h.html#af00a8ce0f071a8a966bc66294fdd9081">cbufHasWholePacket</a>(CIRBUF_RX_DEBUG)) {</div>
<div class="line">        <span class="comment">//&#39;hi&#39; - Reply with &quot;Hello&quot; on a new line</span></div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a11"></a><a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;hi&quot;</span>) == 0) {</div>
<div class="line">            <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nHello&quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//&#39;rst&#39; - Send reset command to DS2482 chip</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;rst&quot;</span>) == 0) {</div>
<div class="line">            ds2482_reset(DS2482);</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//&#39;1w-rst&#39; - Send a 1-Wire reset command to DS2482 chip</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;owRst&quot;</span>) == 0) {</div>
<div class="line">            <span class="comment">//Send &quot;1-Wire Reset&quot; command</span></div>
<div class="line">            owReset(DS2482);</div>
<div class="line"></div>
<div class="line">            <span class="comment">//Wait till done, and get status</span></div>
<div class="line">            <span class="keywordflow">if</span> (ds2482_getStatusWait(DS2482) != 0) {</div>
<div class="line">                <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_WARNING, <span class="stringliteral">&quot;\nowReset() Error!&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="comment">//Add custom debug message processing</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="nz__circular_buffer_8h.html#a5ce13d16c59e3a6e02d750c462d9aad6">cbufPacketStrcmp</a>(CIRBUF_RX_DEBUG, <span class="stringliteral">&quot;...&quot;</span>) == 0) {</div>
<div class="line">            <a class="code" href="nz__debug_8h.html#aec1c1eaa2fbd5b17bda3241d995a2378">DEBUG_PUT_STR</a>(DEBUG_LEVEL_INFO, <span class="stringliteral">&quot;\nReceived unknown debug message&quot;</span>);</div>
<div class="line">            <span class="comment">//..... Do something</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">//Remove received packet. If it was not processed above, it is lost!</span></div>
<div class="line">        <a name="a12"></a><a class="code" href="nz__circular_buffer_8h.html#a41ff25acfdec531e69b8437abb11b720">cbufRemovePacket</a>(CIRBUF_RX_DEBUG);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Dec 9 2014 15:08:18 for Netcruzer Library API by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
